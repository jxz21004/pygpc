name: Build 

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
        include:
          - python-version: "3.9"
            cibw-string: "cp39-*"
          - python-version: "3.10"
            cibw-string: "cp310-*"
          - python-version: "3.11"
            cibw-string: "cp311-*"
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Cython matplotlib seaborn cibuildwheel twine
        pip install -r requirements.txt
        pip install .
    - name: Test with unittest
      run: |
        cd tests
        # python -m unittest
        cd .. 
    - name: Build with cibuildwheel
      run: |
        python -m cibuildwheel --output-dir wheelhouse
        ls wheelhouse/
      env:
        CIBW_MANYLINUX_X86_64_IMAGE: "manylinux2014"
        CIBW_BEFORE_BUILD: "pip install numpy"
        CIBW_BUILD: ${{ matrix.cibw-string }}
        CIBW_SKIP: "*-musllinux_* *i686*"
    - name: Upload with twine
      if: "contains(github.event.head_commit.message, 'PyPI')"
      run: |
        python -m twine upload wheelhouse/*.whl
      env:
        TWINE_PASSWORD: ${{ secrets.twine_api_key }}
        TWINE_USERNAME: __token__
  windows:
    runs-on: windows-2019
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
        include:
          - python-version: "3.9"
            cibw-string: "cp39-*"
          - python-version: "3.10"
            cibw-string: "cp310-*"
          - python-version: "3.11"
            cibw-string: "cp311-*"
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Cython matplotlib seaborn cibuildwheel twine
        pip install -r requirements.txt
        pip install .
    - name: Test with unittest
      run: |
        cd tests
        # python -m unittest
        cd .. 
    - name: Build with cibuildwheel
      run: |
        python -m cibuildwheel --output-dir wheelhouse
        ls wheelhouse/
      env:
        CIBW_BEFORE_BUILD: "pip install numpy"
        CIBW_BUILD: ${{ matrix.cibw-string }} 
    - name: Upload with twine
      if: "contains(github.event.head_commit.message, 'PyPI')"
      run: |
        python -m twine upload wheelhouse/*.whl
      env:
        TWINE_PASSWORD: ${{ secrets.twine_api_key }}
        TWINE_USERNAME: __token__
  macos:
    runs-on: macos-11
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
        include:
          - python-version: "3.9"
            cibw-string: "cp39-*"
          - python-version: "3.10"
            cibw-string: "cp310-*"
          - python-version: "3.11"
            cibw-string: "cp311-*"
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        MACOSX_DEPLOYMENT_TARGET=10.11 brew install gcc@13
        MACOSX_DEPLOYMENT_TARGET=10.11 python -m pip install --upgrade pip
        MACOSX_DEPLOYMENT_TARGET=10.11 pip install Cython matplotlib seaborn cibuildwheel twine
        MACOSX_DEPLOYMENT_TARGET=10.11 pip install -r requirements.txt
        MACOSX_DEPLOYMENT_TARGET=10.11 CC=gcc-13 CXX=g++-13 pip install .
    - name: Test with unittest
      run: |
        cd tests
        # python -m unittest
        cd .. 
    - name: Build with cibuildwheel
      run: |
        python -m cibuildwheel --output-dir wheelhouse
        ls wheelhouse/
      env:
        MACOSX_DEPLOYMENT_TARGET: "10.11"
        CIBW_BEFORE_BUILD: "pip install numpy"
        CIBW_ARCHS_MACOS: x86_64
        CIBW_BUILD: ${{ matrix.cibw-string }} 
        CIBW_REPAIR_WHEEL_COMMAND: "delocate-listdeps {wheel} && delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}"
        CC: gcc-13
        CXX: g++-13
    - name: Upload with twine
      if: "contains(github.event.head_commit.message, 'PyPI')"
      run: |
        python -m twine upload wheelhouse/*.whl
      env:
        TWINE_PASSWORD: ${{ secrets.twine_api_key }}
        TWINE_USERNAME: __token__
