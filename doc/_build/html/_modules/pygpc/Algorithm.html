
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pygpc.Algorithm &#8212; pygpc 0.12.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pygpc/Algorithm';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://pydata-sphinx-theme.readthedocs.io/en/latest/_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'v0.12.0';
        </script>
    <link rel="canonical" href="http://127.0.0.1:8000/_modules/pygpc/Algorithm.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">  
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div><div class="bd-header-announcement container-fluid" id="header-announcement">
    


<script>
$.get("https://raw.githubusercontent.com/pydata/pydata-sphinx-theme/main/docs/_templates/custom-template.html", success=(data)=>{
      $("#header-announcement").html(`<div class="bd-header-announcement__content">${data}</div>`);
  }).fail(() => {
  console.log("[PST]: Failed to load announcement at: https://raw.githubusercontent.com/pydata/pydata-sphinx-theme/main/docs/_templates/custom-template.html")
});
</script>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../index.html">

  
  
  
  
  
  
  

  
    <img src="../../_static/" class="logo__image only-light" alt="pygpc">
    <img src="../../_static/logo.png" class="logo__image only-dark" alt="pygpc">
  
  
    <p class="title logo__title">pygpc</p>
  
</a>
    
  </div>

  
  <div class=" navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <div class="version-switcher__container dropdown">
    <button type="button" class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle" data-toggle="dropdown">
        v0.12.0  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div class="version-switcher__menu dropdown-menu list-group-flush py-0">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>
      </div>
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_introduction/plot_introduction_gpc.html">
                        Introduction to generalized Polynomial Chaos (gPC)
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_introduction/plot_introduction_ua.html">
                        Introduction to uncertainty analysis
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_projection.html">
                        Dimensionality reduction
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_problem.html">
                        How to define a gPC problem
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_gpc_validation.html">
                        Validation of gPC approximation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_model.html">
                        Setting up your model
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_basis.html">
                        Polynomial basis functions
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_gradient_enhanced_gpc.html">
                        Gradient enhanced gPC
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_static_IO.html">
                        Algorithm: Static_IO
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_regadaptive.html">
                        Algorithm: RegAdaptive
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_static_quad.html">
                        Algorithm: Static (Quadrature)
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_static_reg.html">
                        Algorithm: Static (Regression)
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_staticprojection.html">
                        Algorithm: StaticProjection
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_regadaptiveprojection.html">
                        Algorithm: RegAdaptiveProjection
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_mestatic.html">
                        Algorithm: MEStatic
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_mestaticprojection.html">
                        Algorithm: MEStaticProjection
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_mestatic_IO.html">
                        Algorithm: MEStatic_IO
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_meregadaptiveprojection.html">
                        Algorithm: MERegAdaptiveProjection
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/plot_julia_model.html">
                        Analyzing julia models with pygpc
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/plot_matlab_model.html">
                        Analyzing MATLAB models with pygpc
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/plot_parallelization.html">
                        Parallel processing capabilities of pygpc
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/plot_backends.html">
                        OpenMP and CUDA
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_examples/plot_electrode.html">
                        Example: Modelling of an electrode
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../pygpc.html">
                        pygpc package
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_introduction/index.html">
                        Introduction
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/index.html">
                        Generalized Polynomial Chaos
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/index.html">
                        Algorithms
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/index.html">
                        Features
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/pygpc-polynomial-chaos/pygpc" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://twitter.com/k_weise_" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/pygpc/" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-solid fa-box"></i></span>
            <label class="sr-only">PyPI</label></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          <a href="https://pydata.org" title="pygpc" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><img src="../../_static/logo.png" class="icon-link-image" alt="pygpc"/></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <div class="version-switcher__container dropdown">
    <button type="button" class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle" data-toggle="dropdown">
        v0.12.0  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div class="version-switcher__menu dropdown-menu list-group-flush py-0">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>
      </div>
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_introduction/plot_introduction_gpc.html">
                        Introduction to generalized Polynomial Chaos (gPC)
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_introduction/plot_introduction_ua.html">
                        Introduction to uncertainty analysis
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_projection.html">
                        Dimensionality reduction
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_problem.html">
                        How to define a gPC problem
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_gpc_validation.html">
                        Validation of gPC approximation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_model.html">
                        Setting up your model
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_basis.html">
                        Polynomial basis functions
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/plot_gradient_enhanced_gpc.html">
                        Gradient enhanced gPC
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_static_IO.html">
                        Algorithm: Static_IO
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_regadaptive.html">
                        Algorithm: RegAdaptive
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_static_quad.html">
                        Algorithm: Static (Quadrature)
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_static_reg.html">
                        Algorithm: Static (Regression)
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_staticprojection.html">
                        Algorithm: StaticProjection
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_regadaptiveprojection.html">
                        Algorithm: RegAdaptiveProjection
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_mestatic.html">
                        Algorithm: MEStatic
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_mestaticprojection.html">
                        Algorithm: MEStaticProjection
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_mestatic_IO.html">
                        Algorithm: MEStatic_IO
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/plot_algorithm_meregadaptiveprojection.html">
                        Algorithm: MERegAdaptiveProjection
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/plot_julia_model.html">
                        Analyzing julia models with pygpc
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/plot_matlab_model.html">
                        Analyzing MATLAB models with pygpc
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/plot_parallelization.html">
                        Parallel processing capabilities of pygpc
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/plot_backends.html">
                        OpenMP and CUDA
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_examples/plot_electrode.html">
                        Example: Modelling of an electrode
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../pygpc.html">
                        pygpc package
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_introduction/index.html">
                        Introduction
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_gpc/index.html">
                        Generalized Polynomial Chaos
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_algorithms/index.html">
                        Algorithms
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../auto_features/index.html">
                        Features
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/pygpc-polynomial-chaos/pygpc" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://twitter.com/k_weise_" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/pygpc/" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-solid fa-box"></i></span>
            <label class="sr-only">PyPI</label></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          <a href="https://pydata.org" title="pygpc" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><img src="../../_static/logo.png" class="icon-link-image" alt="pygpc"/></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
               <h1>Source code for pygpc.Algorithm</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.Problem</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.SGPC</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">determine_projection_matrix</span><span class="p">,</span> <span class="n">poly_expand</span><span class="p">,</span> <span class="n">get_non_enclosed_multi_indices</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">get_num_coeffs_sparse</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">ten2mat</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">mat2ten</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">get_gradient_idx_domain</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">get_coords_discontinuity</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">increment_basis</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">get_coords_discontinuity</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">get_num_coeffs_sparse</span>
<span class="kn">from</span> <span class="nn">.testfunctions</span> <span class="kn">import</span> <span class="n">Dummy</span>
<span class="kn">from</span> <span class="nn">.Grid</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.MEGPC</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.Classifier</span> <span class="kn">import</span> <span class="n">Classifier</span>
<span class="kn">from</span> <span class="nn">.Gradient</span> <span class="kn">import</span> <span class="n">get_gradient</span>


<div class="viewcode-block" id="Algorithm"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.Algorithm">[docs]</a><span class="k">class</span> <span class="nc">Algorithm</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for GPC algorithms</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem : Problem object</span>
<span class="sd">        Object instance of gPC problem to investigate</span>
<span class="sd">    options : dict</span>
<span class="sd">        Algorithm specific options (see sub-classes for more details)</span>
<span class="sd">    grid : Grid object</span>
<span class="sd">        Grid object</span>
<span class="sd">    validation : ValidationSet object</span>
<span class="sd">        ValidationSet object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes GPC algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation</span> <span class="o">=</span> <span class="n">validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_gradient</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Generate results folder if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_basic_options</span><span class="p">()</span>

<div class="viewcode-block" id="Algorithm.check_basic_options"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.Algorithm.check_basic_options">[docs]</a>    <span class="k">def</span> <span class="nf">check_basic_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks self.options dictionary and sets default</span>

<span class="sd">        options[&quot;eps&quot;] : float, optional, default=1e-3</span>
<span class="sd">            Relative mean error of leave-one-out cross validation</span>
<span class="sd">        options[&quot;error_norm&quot;] : str, optional, default=&quot;relative&quot;</span>
<span class="sd">            Choose if error is determined &quot;relative&quot; or &quot;absolute&quot;. Use &quot;absolute&quot; error when the</span>
<span class="sd">            model generates outputs equal to zero.</span>
<span class="sd">        options[&quot;error_type&quot;] : str, optional, default=&quot;loocv&quot;</span>
<span class="sd">            Choose type of error to validate gpc approximation. Use &quot;loocv&quot; (Leave-one-Out cross validation)</span>
<span class="sd">            to omit any additional calculations and &quot;nrmsd&quot; (normalized root mean square deviation) to compare</span>
<span class="sd">            against a Problem.ValidationSet.</span>
<span class="sd">        options[&quot;fn_results&quot;] : string, optional, default=None</span>
<span class="sd">            If provided, model evaluations are saved in fn_results.hdf5 file and gpc object in fn_results.pkl file</span>
<span class="sd">        options[&quot;gradient_enhanced&quot;] : boolean, optional, default: False</span>
<span class="sd">            Use gradient information to determine the gPC coefficients.</span>
<span class="sd">        options[&quot;gradient_calculation&quot;] : str, optional, default=&quot;standard_forward&quot;</span>
<span class="sd">            Type of the calculation scheme to determine the gradient in the grid points</span>
<span class="sd">            - &quot;FD_fwd&quot;: Finite difference forward approximation of the gradient using n_grid x dim additional sampling</span>
<span class="sd">            points stored in self.grid.coords_gradient and self.grid.coords_gradient_norm [n_grid x dim x dim].</span>
<span class="sd">            - &quot;FD_1st&quot;: Finite difference approximation of 1st order accuracy using only the available samples [1]</span>
<span class="sd">            - &quot;FD_2nd&quot;: Finite difference approximation of 2nd order accuracy using only the available samples [1]</span>
<span class="sd">            - &quot;FD_1st2nd&quot;: Finite difference approximation of 1st and (where possible) 2nd order accuracy</span>
<span class="sd">        options[&quot;gradient_calculation_options&quot;] : dict, optional, default: {&quot;dx&quot;: 0.01, &quot;distance_weight&quot;: -2}</span>
<span class="sd">            Options for gradient calculation (details in get_gradient() function in Gradient.py)</span>
<span class="sd">        options[&quot;backend&quot;] : str, optional, default: &quot;python&quot;</span>
<span class="sd">            Default computing backend, certain functions can be computed with Multicore-CPU or GPU acceleration</span>
<span class="sd">        options[&quot;lambda_eps_gradient&quot;] : float, optional, default: 0.95</span>
<span class="sd">            Bound of principal components in %. All eigenvectors are included until lambda_eps of total sum of all</span>
<span class="sd">            eigenvalues is included in the system.</span>
<span class="sd">        options[&quot;matrix_ratio&quot;]: float, optional, default=1.5</span>
<span class="sd">            Ration between the number of model evaluations and the number of basis functions.</span>
<span class="sd">            If &quot;adaptive_sampling&quot; is activated this factor is only used to</span>
<span class="sd">            construct the initial grid depending on the initial number of basis functions determined by &quot;order_start&quot;.</span>
<span class="sd">            (&gt;1 results in an overdetermined system)</span>
<span class="sd">        options[&quot;matlab_model&quot;] : boolean, optional, default: False</span>
<span class="sd">            Use a Matlab model function</span>
<span class="sd">        options[&quot;method&quot;]: str</span>
<span class="sd">            GPC method to apply [&#39;Reg&#39;, &#39;Quad&#39;]</span>
<span class="sd">        options[&quot;n_cpu&quot;] : int, optional, default=1</span>
<span class="sd">            Number of threads to use for parallel evaluation of the model function.</span>
<span class="sd">        options[&quot;n_samples_validation&quot;] : int, optional, default: 1e4</span>
<span class="sd">            Number of validation points used to determine the NRMSD if chosen as &quot;error_type&quot;. Does not create a</span>
<span class="sd">            validation set if there is already one present in the Problem instance (problem.validation).</span>
<span class="sd">        options[&quot;print_func_time&quot;] : boolean, optional, default: False</span>
<span class="sd">            Print function evaluation time for every single run</span>
<span class="sd">        options[&quot;projection&quot;] : boolean, optional, default: False</span>
<span class="sd">            Use projection approach</span>
<span class="sd">        options[&quot;solver&quot;]: str</span>
<span class="sd">            Solver to determine the gPC coefficients</span>
<span class="sd">            - &#39;Moore-Penrose&#39; ... Pseudoinverse of gPC matrix (SGPC.Reg, EGPC)</span>
<span class="sd">            - &#39;OMP&#39; ... Orthogonal Matching Pursuit, sparse recovery approach (SGPC.Reg, EGPC)</span>
<span class="sd">        options[&quot;settings&quot;]: dict</span>
<span class="sd">            Solver settings</span>
<span class="sd">            - &#39;Moore-Penrose&#39; ... None</span>
<span class="sd">            - &#39;OMP&#39; ... {&quot;n_coeffs_sparse&quot;: int} Number of gPC coefficients != 0</span>
<span class="sd">        options[&quot;verbose&quot;] : boolean, optional, default=True</span>
<span class="sd">            Print output of iterations and sub-iterations (True/False)</span>
<span class="sd">        options[&quot;backend&quot;] : str</span>
<span class="sd">            Backend for performance intensive computations</span>
<span class="sd">            - &quot;python&quot; ... Use native python implementation</span>
<span class="sd">            - &quot;cpu&quot; .. Use C Implementaion without multicore-support</span>
<span class="sd">        options[&quot;plot_basis&quot;] : bool</span>
<span class="sd">            Plot basis functions and save as fn_results + _basis_iter#.png</span>
<span class="sd">        options[&quot;grid_extension_method&quot;] : str, optional, default: GPR</span>
<span class="sd">            Method to extend random grids when adaptive_sampling is turned on:</span>
<span class="sd">            - &quot;GPR&quot;: Gaussian Process Regression (sample location is optimized according to posterior variance)</span>
<span class="sd">            - &quot;random&quot;: Samples are added randomly</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;eps&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>

        <span class="k">if</span> <span class="s2">&quot;error_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relative&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;error_type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;loocv&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;fn_results&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;gradient_enhanced&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;gradient_calculation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FD_fwd&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;gradient_calculation_options&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dx&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s2">&quot;distance_weight&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;dx&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.001</span>

        <span class="k">if</span> <span class="s2">&quot;distance_weight&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;distance_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

        <span class="k">if</span> <span class="s2">&quot;backend&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;backend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;lambda_eps_gradient&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;lambda_eps_gradient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.95</span>

        <span class="k">if</span> <span class="s2">&quot;matrix_ratio&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matrix_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="s2">&quot;matlab_model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matlab_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;quad&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NumInt&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;reg&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Moore-Penrose&quot;</span> <span class="ow">or</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OMP&quot;</span> <span class="ow">or</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LarsLasso&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;Moore-Penrose&#39; or &#39;OMP&#39; as solver for &#39;reg&#39; method&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;n_cpu&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_cpu&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_cpu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="s2">&quot;n_samples_validation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e4</span>

        <span class="k">if</span> <span class="s2">&quot;save_session_format&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;save_session_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.hdf5&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;save_session_format&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;save_session_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.hdf5&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;save_session_format&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.hdf5&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;save_session_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.hdf5&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;save_session_format&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.pkl&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;save_session_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.pkl&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                         <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;save_session_format&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;save_session_format&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;session&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;print_func_time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;projection&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;seed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Moore-Penrose&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OMP&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;settings&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="s2">&quot;n_coeffs_sparse&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span>
                <span class="s2">&quot;sparsity&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify correct solver settings for OMP in &#39;settings&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LarsLasso&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;settings&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;alpha&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">][</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;verbose&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;grid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Random</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;backend&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;backend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;n_grid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;adaptive_sampling&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;plot_basis&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;plot_basis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;grid_extension_method&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_extension_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GPR&quot;</span></div></div>


<div class="viewcode-block" id="Static_IO"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.Static_IO">[docs]</a><span class="k">class</span> <span class="nc">Static_IO</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Static gPC algorithm, which uses precomputed input output relationships to construct the gPC approximation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters: OrderedDict containing the RandomParameter class instances</span>
<span class="sd">        Dictionary (ordered) containing the properties of the random parameters</span>
<span class="sd">    options[&quot;order&quot;]: list of int [dim]</span>
<span class="sd">        Maximum individual expansion order [order_1, order_2, ..., order_dim].</span>
<span class="sd">        Generates individual polynomials also if maximum expansion order in order_max is exceeded</span>
<span class="sd">    options[&quot;order_max&quot;]: int</span>
<span class="sd">        Maximum global expansion order.</span>
<span class="sd">        The maximum expansion order considers the sum of the orders of combined polynomials together with the</span>
<span class="sd">        chosen norm &quot;order_max_norm&quot;. Typically this norm is 1 such that the maximum order is the sum of all</span>
<span class="sd">        monomial orders.</span>
<span class="sd">    options[&quot;order_max_norm&quot;]: float</span>
<span class="sd">        Norm for which the maximum global expansion order is defined [0, 1]. Values &lt; 1 decrease the total number</span>
<span class="sd">        of polynomials in the expansion such that interaction terms are penalized more. This truncation scheme</span>
<span class="sd">        is also referred to &quot;hyperbolic polynomial chaos expansion&quot; such that sum(a_i^q)^1/q &lt;= p,</span>
<span class="sd">        where p is order_max and q is order_max_norm (for more details see eq. (27) in [1]).</span>
<span class="sd">    options[&quot;interaction_order&quot;]: int</span>
<span class="sd">        Number of random variables, which can interact with each other.</span>
<span class="sd">        All polynomials are ignored, which have an interaction order greater than the specified</span>
<span class="sd">    grid: Grid object instance</span>
<span class="sd">        Grid object to use for static gPC (Random, SparseGrid, TensorGrid) containing the parameter values, where the</span>
<span class="sd">        output relations were calculated</span>
<span class="sd">    results: ndarray of float [N_grid x N_qoi]</span>
<span class="sd">        Model output at each grid point for each QOI</span>
<span class="sd">    validation: Validation Set class instance, optional</span>
<span class="sd">        Validation set containing reference solutions at precomputed grid points</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pygpc</span>
<span class="sd">    &gt;&gt;&gt; # initialize static gPC algorithm using precomputed IO relationships</span>
<span class="sd">    &gt;&gt;&gt; algorithm = pygpc.Static_IO(parameters=parameters, options=options, grid=grid, results=results)</span>
<span class="sd">    &gt;&gt;&gt; # run algorithm</span>
<span class="sd">    &gt;&gt;&gt; gpc, coeffs = algorithm.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes static gPC algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create dummy model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">()</span>

        <span class="c1"># create dummy problem</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Static_IO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">results</span>

        <span class="k">if</span> <span class="s2">&quot;order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order&#39;=[order_1, order_2, ..., order_dim] in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order_max&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order_max&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order_max_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;interaction_order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span>

        <span class="k">if</span> <span class="s2">&quot;error_type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;loocv&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;loocv&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;loocv&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Changing error calculation type to loocv ...&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Static_IO.run"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.Static_IO.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs static gPC algorithm using precomputed IO relationships to construct surrogate model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gpc : GPC object instance</span>
<span class="sd">            GPC object containing all information i.e., Problem, Model, Grid, Basis, RandomParameter instances</span>
<span class="sd">        coeffs: ndarray of float [n_basis x n_out]</span>
<span class="sd">            GPC coefficients</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Initialize gPC object</span>
        <span class="n">gpc</span> <span class="o">=</span> <span class="n">Reg</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                  <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">],</span>
                  <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                  <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                  <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                  <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                  <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                  <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

        <span class="n">gpc</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;backend&quot;</span><span class="p">]</span>

        <span class="c1"># determine number of basis functions</span>
        <span class="n">n_coeffs</span> <span class="o">=</span> <span class="n">get_num_coeffs_sparse</span><span class="p">(</span><span class="n">order_dim_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">],</span>
                                         <span class="n">order_glob_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                         <span class="n">order_inter_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                         <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &gt; Determining </span><span class="si">{</span><span class="n">n_coeffs</span><span class="si">}</span><span class="s2"> gPC coeffs with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> simulations!&quot;</span><span class="p">)</span>

        <span class="c1"># Write grid in gpc object</span>
        <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>

        <span class="c1"># Initialize gpc matrix</span>
        <span class="n">gpc</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">()</span>

        <span class="c1"># Compute gpc coefficients</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">,</span>
                           <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">],</span>
                           <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">],</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="c1"># validate gpc approximation (determine nrmsd or loocv specified in options[&quot;error_type&quot;])</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>

        <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                            <span class="n">eps</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="c1"># save gpc object and gpc coeffs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">,</span>
                                 <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session_folder&quot;</span><span class="p">,</span>
                                 <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gpc</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span></div></div>


<div class="viewcode-block" id="Static"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.Static">[docs]</a><span class="k">class</span> <span class="nc">Static</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Static gPC algorithm</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem : Problem object</span>
<span class="sd">        Object instance of gPC problem to investigate</span>
<span class="sd">    options[&quot;method&quot;]: str</span>
<span class="sd">        GPC method to apply [&#39;Reg&#39;, &#39;Quad&#39;]</span>
<span class="sd">    options[&quot;order&quot;]: list of int [dim]</span>
<span class="sd">        Maximum individual expansion order [order_1, order_2, ..., order_dim].</span>
<span class="sd">        Generates individual polynomials also if maximum expansion order in order_max is exceeded</span>
<span class="sd">    options[&quot;order_max&quot;]: int</span>
<span class="sd">        Maximum global expansion order.</span>
<span class="sd">        The maximum expansion order considers the sum of the orders of combined polynomials together with the</span>
<span class="sd">        chosen norm &quot;order_max_norm&quot;. Typically this norm is 1 such that the maximum order is the sum of all</span>
<span class="sd">        monomial orders.</span>
<span class="sd">    options[&quot;order_max_norm&quot;]: float</span>
<span class="sd">        Norm for which the maximum global expansion order is defined [0, 1]. Values &lt; 1 decrease the total number</span>
<span class="sd">        of polynomials in the expansion such that interaction terms are penalized more. This truncation scheme</span>
<span class="sd">        is also referred to &quot;hyperbolic polynomial chaos expansion&quot; such that sum(a_i^q)^1/q &lt;= p,</span>
<span class="sd">        where p is order_max and q is order_max_norm (for more details see eq. (27) in [1]).</span>
<span class="sd">    options[&quot;interaction_order&quot;]: int</span>
<span class="sd">        Number of random variables, which can interact with each other.</span>
<span class="sd">        All polynomials are ignored, which have an interaction order greater than the specified</span>
<span class="sd">    grid: Grid object instance</span>
<span class="sd">        Grid object to use for static gPC (Random, SparseGrid, TensorGrid)</span>
<span class="sd">    validation: Validation Set class instance, optional</span>
<span class="sd">        Validation set containing reference solutions at precomputed grid points</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. [1] Blatman, G., &amp; Sudret, B. (2011). Adaptive sparse polynomial chaos expansion based on least angle</span>
<span class="sd">       regression. Journal of Computational Physics, 230(6), 2345-2367.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pygpc</span>
<span class="sd">    &gt;&gt;&gt; # initialize static gPC algorithm</span>
<span class="sd">    &gt;&gt;&gt; algorithm = pygpc.Static(problem=problem, options=options, grid=grid)</span>
<span class="sd">    &gt;&gt;&gt; # run algorithm</span>
<span class="sd">    &gt;&gt;&gt; gpc, coeffs, results = algorithm.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gpc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes static gPC algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Static</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpc</span> <span class="o">=</span> <span class="n">gpc</span>

        <span class="c1"># check contents of settings dict and set defaults</span>
        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;method&#39; with either &#39;reg&#39; or &#39;quad&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order&#39;=[order_1, order_2, ..., order_dim] in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order_max&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order_max&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order_max_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;interaction_order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span>

<div class="viewcode-block" id="Static.run"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.Static.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs static gPC algorithm to solve problem.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gpc : GPC object instance</span>
<span class="sd">            GPC object containing all information i.e., Problem, Model, Grid, Basis, RandomParameter instances</span>
<span class="sd">        coeffs: ndarray of float [n_basis x n_out]</span>
<span class="sd">            GPC coefficients</span>
<span class="sd">        res : ndarray of float [n_grid x n_out]</span>
<span class="sd">            Simulation results at n_grid points of the n_out output variables</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gradient_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create gPC object</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;reg&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gpc</span> <span class="o">=</span> <span class="n">Reg</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">],</span>
                          <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                          <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                          <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                          <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                          <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                          <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpc</span>
                <span class="n">gpc</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span>
                <span class="n">gpc</span><span class="o">.</span><span class="n">fn_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;quad&quot;</span><span class="p">:</span>
            <span class="n">gpc</span> <span class="o">=</span> <span class="n">Quad</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                       <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">],</span>
                       <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                       <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                       <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                       <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                       <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                       <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify correct gPC method (&#39;reg&#39; or &#39;quad&#39;)&quot;</span><span class="p">)</span>

        <span class="n">gpc</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;backend&quot;</span><span class="p">]</span>

        <span class="c1"># determine number of basis functions</span>
        <span class="n">n_coeffs</span> <span class="o">=</span> <span class="n">get_num_coeffs_sparse</span><span class="p">(</span><span class="n">order_dim_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">],</span>
                                         <span class="n">order_glob_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                         <span class="n">order_inter_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                         <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matrix_ratio&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_coeffs</span>

        <span class="c1"># Write grid in gpc object</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;reg&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using user-predefined grid with n_grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                                <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                                <span class="n">coords_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                                <span class="n">coords_gradient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                                <span class="n">coords_gradient_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                                <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;quad&quot;</span><span class="p">:</span>
                <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Random</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LHS</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GP</span><span class="p">:</span>
            <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                            <span class="n">n_grid</span><span class="o">=</span><span class="n">n_grid</span><span class="p">,</span>
                                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">L1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">L1_LHS</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LHS_L1</span>\
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIM</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">CO</span><span class="p">:</span>
            <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                            <span class="n">n_grid</span><span class="o">=</span><span class="n">n_grid</span><span class="p">,</span>
                                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">],</span>
                                            <span class="n">gpc</span><span class="o">=</span><span class="n">gpc</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Grid not provided and specified grid type not known!&quot;</span><span class="p">)</span>

        <span class="n">gpc</span><span class="o">.</span><span class="n">interaction_order_current</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">])</span>

        <span class="c1"># Initialize parallel Computation class</span>
        <span class="n">com</span> <span class="o">=</span> <span class="n">Computation</span><span class="p">(</span><span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">,</span> <span class="n">matlab_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matlab_model&quot;</span><span class="p">])</span>

        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">eps_pre</span> <span class="o">=</span> <span class="n">eps</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">i_grid</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># determine gpc approximation and determine error (increase grid size in case of adaptive sampling)</span>
        <span class="k">while</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>
            <span class="c1"># Run simulations</span>
            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">{}</span><span class="s2"> simulations!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">-</span> <span class="n">i_grid</span><span class="p">),</span>
                   <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                    <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                    <span class="n">coords</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="p">:],</span>
                                    <span class="n">coords_norm</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="p">:],</span>
                                    <span class="n">i_iter</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">order_max</span><span class="p">,</span>
                                    <span class="n">i_subiter</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">interaction_order</span><span class="p">,</span>
                                    <span class="n">fn_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">res_list</span><span class="p">)</span>
            <span class="n">i_grid</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span>

            <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total parallel function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                   <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="c1"># Determine gradient [n_grid x n_out x dim]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="n">grad_res_3D</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                         <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                         <span class="n">grid</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
                                                         <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                         <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                         <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">],</span>
                                                         <span class="n">gradient_results_present</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                         <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                         <span class="n">i_iter</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">order_max</span><span class="p">,</span>
                                                         <span class="n">i_subiter</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">interaction_order</span><span class="p">,</span>
                                                         <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                         <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">],</span>
                                                         <span class="n">distance_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;distance_weight&quot;</span><span class="p">],</span>
                                                         <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                       <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="c1"># Initialize gpc matrix</span>
            <span class="n">gpc</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>

            <span class="c1"># Compute gpc coefficients</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                               <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D</span><span class="p">,</span>
                               <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">],</span>
                               <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">],</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="c1"># create validation set if necessary</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="n">gpc</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gpc</span><span class="o">.</span><span class="n">create_validation_set</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_validation&quot;</span><span class="p">],</span>
                                          <span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_cpu&quot;</span><span class="p">])</span>

            <span class="c1"># validate gpc approximation (determine nrmsd or loocv specified in options[&quot;error_type&quot;])</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D</span><span class="p">)</span>

            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                                <span class="n">eps</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>  <span class="c1"># (0 &lt; (eps_pre-eps)/eps &lt; 0.01):</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>
                <span class="c1"># extend grid by 5% of number of basis functions and restart loop</span>
                <span class="n">n_grid_new</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># int(np.ceil(gpc.grid.n_grid + 5e-2 * gpc.basis.n_basis))</span>
                <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Extending grid from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> by </span><span class="si">{}</span><span class="s1"> sampling points using grid_extension_method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">n_grid_new</span><span class="p">,</span> <span class="n">n_grid_new</span> <span class="o">-</span> <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_extension_method&quot;</span><span class="p">]),</span>
                    <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_extension_method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GPR&quot;</span><span class="p">:</span>
                    <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span><span class="n">n_grid_new</span><span class="o">=</span><span class="n">n_grid_new</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span><span class="n">n_grid_new</span><span class="o">=</span><span class="n">n_grid_new</span><span class="p">)</span>

            <span class="c1"># eps_pre = eps</span>

        <span class="c1"># save gpc object and gpc coeffs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">,</span>
                                 <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session_folder&quot;</span><span class="p">,</span>
                                 <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">grad_res_3D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ten2mat</span><span class="p">(</span><span class="n">grad_res_3D</span><span class="p">),</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gradient_idx</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

        <span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">gpc</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="MEStatic"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.MEStatic">[docs]</a><span class="k">class</span> <span class="nc">MEStatic</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multi-Element Static gPC algorithm</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem : Problem object</span>
<span class="sd">        Object instance of gPC problem to investigate</span>
<span class="sd">    options[&quot;method&quot;]: str</span>
<span class="sd">        GPC method to apply [&#39;Reg&#39;, &#39;Quad&#39;]</span>
<span class="sd">    options[&quot;order&quot;]: list of int [dim]</span>
<span class="sd">        Maximum individual expansion order [order_1, order_2, ..., order_dim].</span>
<span class="sd">        Generates individual polynomials also if maximum expansion order in order_max is exceeded</span>
<span class="sd">    options[&quot;order_max&quot;]: int</span>
<span class="sd">        Maximum global expansion order.</span>
<span class="sd">        The maximum expansion order considers the sum of the orders of combined polynomials together with the</span>
<span class="sd">        chosen norm &quot;order_max_norm&quot;. Typically this norm is 1 such that the maximum order is the sum of all</span>
<span class="sd">        monomial orders.</span>
<span class="sd">    options[&quot;order_max_norm&quot;]: float</span>
<span class="sd">        Norm for which the maximum global expansion order is defined [0, 1]. Values &lt; 1 decrease the total number</span>
<span class="sd">        of polynomials in the expansion such that interaction terms are penalized more. This truncation scheme</span>
<span class="sd">        is also referred to &quot;hyperbolic polynomial chaos expansion&quot; such that sum(a_i^q)^1/q &lt;= p,</span>
<span class="sd">        where p is order_max and q is order_max_norm (for more details see eq. (27) in [1]).</span>
<span class="sd">    options[&quot;interaction_order&quot;]: int</span>
<span class="sd">        Number of random variables, which can interact with each other.</span>
<span class="sd">        All polynomials are ignored, which have an interaction order greater than the specified</span>
<span class="sd">    options[&quot;qoi&quot;] : int or str, optional, default: 0</span>
<span class="sd">        Choose for which QOI the projection is determined for. The other QOIs use the same projection.</span>
<span class="sd">        Alternatively, the projection can be determined for every QOI independently (qoi_index or &quot;all&quot;).</span>
<span class="sd">    options[&quot;classifier&quot;] : str, optional, default: &quot;learning&quot;</span>
<span class="sd">        Classification algorithm to subdivide parameter domain.</span>
<span class="sd">        - &quot;learning&quot; ... ClassifierLearning algorithm based on Unsupervised and supervised learning</span>
<span class="sd">    options[&quot;classifier_options&quot;] : dict, optional, default: default settings</span>
<span class="sd">        Options of classifier</span>
<span class="sd">    grid: Grid object instance</span>
<span class="sd">        Grid object to use for static gPC (Random, SparseGrid, TensorGrid)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. [1] Blatman, G., &amp; Sudret, B. (2011). Adaptive sparse polynomial chaos expansion based on least angle</span>
<span class="sd">       regression. Journal of Computational Physics, 230(6), 2345-2367.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pygpc</span>
<span class="sd">    &gt;&gt;&gt; # initialize static gPC algorithm</span>
<span class="sd">    &gt;&gt;&gt; algorithm = pygpc.MEStatic(problem=problem, options=options, grid=grid)</span>
<span class="sd">    &gt;&gt;&gt; # run algorithm</span>
<span class="sd">    &gt;&gt;&gt; gpc, coeffs, results = algorithm.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes multi-element static gPC algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MEStatic</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># check contents of settings dict and set defaults</span>
        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;method&#39; with either &#39;reg&#39; or &#39;quad&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order&#39;=[order_1, order_2, ..., order_dim] in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order_max&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order_max&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;interaction_order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span>

        <span class="k">if</span> <span class="s2">&quot;order_max_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;qoi&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;classifier&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;learning&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;classifier_options&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier_options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="MEStatic.run"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.MEStatic.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs Multi-Element Static gPC algorithm to solve problem.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        megpc : Multi-element GPC object instance</span>
<span class="sd">            MEGPC object containing all information i.e., Problem, Model, Grid, Basis, RandomParameter instances</span>
<span class="sd">        coeffs: list of ndarray of float [n_gpc][n_basis x n_out]</span>
<span class="sd">            GPC coefficients</span>
<span class="sd">        res : ndarray of float [n_grid x n_out]</span>
<span class="sd">            Simulation results at n_grid points of the n_out output variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">grad_res_3D_all</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gradient_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">res_all_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_grid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Write grid in gpc object</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using user-predefined grid with n_grid=</span><span class="si">{</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                        <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                        <span class="n">coords_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                        <span class="n">coords_gradient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                        <span class="n">coords_gradient_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                        <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">n_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If grid is not provided during initialization please provide options[&#39;n_grid&#39;]&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Random</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LHS</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GP</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating initial grid (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) with n_grid=</span><span class="si">{</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                        <span class="n">n_grid</span><span class="o">=</span><span class="n">n_grid</span><span class="p">,</span>
                                        <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">L1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">L1_LHS</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LHS_L1</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Grid type not possible for MEStatic algorithm.&quot;</span>
                                      <span class="s2">&quot;Please use either &#39;Random&#39; or &#39;LHS&#39;.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Grid not provided and specified grid type not known!&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize parallel Computation class</span>
        <span class="n">com</span> <span class="o">=</span> <span class="n">Computation</span><span class="p">(</span><span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">,</span> <span class="n">matlab_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matlab_model&quot;</span><span class="p">])</span>

        <span class="n">megpc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">i_grid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i_qoi</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">q_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="n">qoi_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">i_qoi</span> <span class="o">&lt;</span> <span class="n">n_qoi</span><span class="p">:</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="n">qoi_idx</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span>
            <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;Determining gPC approximation for QOI #</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>
            <span class="n">iprint</span><span class="p">(</span><span class="n">print_str</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="n">megpc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">coeffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">eps_pre</span> <span class="o">=</span> <span class="n">eps</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># Create MEGPC object</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEGPC</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                 <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

            <span class="c1"># determine gpc approximation and determine error (increase grid size in case of adaptive sampling)</span>
            <span class="k">while</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">i_grid</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">:</span>
                    <span class="c1"># run simulations</span>
                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">{}</span><span class="s2"> simulations!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">-</span> <span class="n">i_grid</span><span class="p">),</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                    <span class="n">res_all_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                <span class="n">coords</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="p">:],</span>
                                                <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="p">:],</span>
                                                <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                                <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                <span class="n">fn_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]))</span>

                    <span class="n">res_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">res_all_list</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">i_qoi</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_grid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">res_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>

                    <span class="n">i_grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="c1"># Determine gradient [n_grid x n_out x dim]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                        <span class="n">grad_res_3D_all</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                     <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                                     <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                                                                     <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                                                     <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                                     <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">],</span>
                                                                     <span class="n">gradient_results_present</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">,</span>
                                                                     <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">,</span>
                                                                     <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                                                     <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                                     <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                                     <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">],</span>
                                                                     <span class="n">distance_weight</span><span class="o">=</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span>
                                                                         <span class="s2">&quot;distance_weight&quot;</span><span class="p">],</span>
                                                                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                        <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                               <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># crop results to considered qoi</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">res_all</span><span class="p">)</span>
                    <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>
                    <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">output_idx_passed_validation</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;/qoi_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>
                    <span class="n">output_idx_passed_validation</span> <span class="o">=</span> <span class="n">q_idx</span>

                    <span class="k">if</span> <span class="n">grad_res_3D_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

                <span class="c1"># Write grid in gpc object</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

                <span class="c1"># determine gpc domains</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_classifier</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                             <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                             <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">],</span>
                                             <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier_options&quot;</span><span class="p">])</span>

                <span class="c1"># initialize sub-gPCs</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">):</span>
                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">add_sub_gpc</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                             <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">)],</span>
                                             <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                             <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                             <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                             <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                             <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                             <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                             <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                <span class="c1"># assign grids to sub-gPCs (rotate sub-grids in case of projection)</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">assign_grids</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>

                <span class="c1"># Initialize gpc matrices</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrices</span><span class="p">()</span>

                <span class="c1"># Compute gpc coefficients</span>
                <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                   <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D</span><span class="p">,</span>
                                                   <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">],</span>
                                                   <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">],</span>
                                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># create validation set if necessary</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">create_validation_set</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_validation&quot;</span><span class="p">],</span>
                                                   <span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_cpu&quot;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

                <span class="c1"># validate gpc approximation (determine nrmsd or loocv specified in options[&quot;error_type&quot;])</span>
                <span class="n">eps</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span> <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D</span><span class="p">)</span>

                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                                    <span class="n">eps</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># domain specific error</span>
                <span class="n">eps_domain</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)))]</span>
                <span class="k">for</span> <span class="n">i_gpc</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)):</span>
                    <span class="n">eps_domain</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                                                          <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                          <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                          <span class="n">output_idx</span><span class="o">=</span><span class="n">output_idx_passed_validation</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">eps_pre</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">):</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>
                    <span class="c1"># extend grid by 10% of number of grid points</span>
                    <span class="n">n_grid_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.1</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">))</span>
                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Extending grid from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> by </span><span class="si">{}</span><span class="s2"> sampling points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">n_grid_new</span><span class="p">,</span> <span class="n">n_grid_new</span> <span class="o">-</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">),</span>
                        <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                    <span class="n">grid</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span><span class="n">n_grid_new</span><span class="o">=</span><span class="n">n_grid_new</span><span class="p">)</span>

                <span class="n">eps_pre</span> <span class="o">=</span> <span class="n">eps</span>

            <span class="c1"># save data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_session</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">]</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session_folder&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">i_gpc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;error&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">eps_domain</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">],</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">i_gpc</span><span class="p">],</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;domains&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i_gpc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                                 <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span>
                                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

            <span class="n">i_qoi</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">]</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">grad_res_3D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ten2mat</span><span class="p">(</span><span class="n">grad_res_3D</span><span class="p">),</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">gradient_idx</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

        <span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">megpc</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="MEStatic_IO"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.MEStatic_IO">[docs]</a><span class="k">class</span> <span class="nc">MEStatic_IO</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multi-Element Static gPC algorithm using precomputed IO data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters: OrderedDict containing the RandomParameter class instances</span>
<span class="sd">        Dictionary (ordered) containing the properties of the random parameters</span>
<span class="sd">    options[&quot;order&quot;]: list of int [dim]</span>
<span class="sd">        Maximum individual expansion order [order_1, order_2, ..., order_dim].</span>
<span class="sd">        Generates individual polynomials also if maximum expansion order in order_max is exceeded</span>
<span class="sd">    options[&quot;order_max&quot;]: int</span>
<span class="sd">        Maximum global expansion order.</span>
<span class="sd">        The maximum expansion order considers the sum of the orders of combined polynomials together with the</span>
<span class="sd">        chosen norm &quot;order_max_norm&quot;. Typically this norm is 1 such that the maximum order is the sum of all</span>
<span class="sd">        monomial orders.</span>
<span class="sd">    options[&quot;order_max_norm&quot;]: float</span>
<span class="sd">        Norm for which the maximum global expansion order is defined [0, 1]. Values &lt; 1 decrease the total number</span>
<span class="sd">        of polynomials in the expansion such that interaction terms are penalized more. This truncation scheme</span>
<span class="sd">        is also referred to &quot;hyperbolic polynomial chaos expansion&quot; such that sum(a_i^q)^1/q &lt;= p,</span>
<span class="sd">        where p is order_max and q is order_max_norm (for more details see eq. (27) in [1]).</span>
<span class="sd">    options[&quot;interaction_order&quot;]: int</span>
<span class="sd">        Number of random variables, which can interact with each other.</span>
<span class="sd">        All polynomials are ignored, which have an interaction order greater than the specified</span>
<span class="sd">    options[&quot;qoi&quot;] : int or str, optional, default: 0</span>
<span class="sd">        Choose for which QOI the projection is determined for. The other QOIs use the same projection.</span>
<span class="sd">        Alternatively, the projection can be determined for every QOI independently (qoi_index or &quot;all&quot;).</span>
<span class="sd">    options[&quot;classifier&quot;] : str, optional, default: &quot;learning&quot;</span>
<span class="sd">        Classification algorithm to subdivide parameter domain.</span>
<span class="sd">        - &quot;learning&quot; ... ClassifierLearning algorithm based on Unsupervised and supervised learning</span>
<span class="sd">    options[&quot;classifier_options&quot;] : dict, optional, default: default settings</span>
<span class="sd">        Options of classifier</span>
<span class="sd">    grid: Grid object instance</span>
<span class="sd">        Grid object to use for static gPC (Random, SparseGrid, TensorGrid) containing the parameter values, where the</span>
<span class="sd">        output relations were calculated</span>
<span class="sd">    results: ndarray of float [N_grid x N_qoi]</span>
<span class="sd">        Model output at each grid point for each QOI</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. [1] Blatman, G., &amp; Sudret, B. (2011). Adaptive sparse polynomial chaos expansion based on least angle</span>
<span class="sd">       regression. Journal of Computational Physics, 230(6), 2345-2367.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pygpc</span>
<span class="sd">    &gt;&gt;&gt; # initialize static gPC algorithm</span>
<span class="sd">    &gt;&gt;&gt; algorithm = pygpc.MEStatic_IO(parameters=parameters, options=options, results=results, grid=grid)</span>
<span class="sd">    &gt;&gt;&gt; # run algorithm</span>
<span class="sd">    &gt;&gt;&gt; gpc, coeffs, results = algorithm.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes multi-element static gPC algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create dummy model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">()</span>

        <span class="c1"># create dummy problem</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">MEStatic_IO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">results</span>

        <span class="c1"># check contents of settings dict and set defaults</span>
        <span class="k">if</span> <span class="s2">&quot;order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order&#39;=[order_1, order_2, ..., order_dim] in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order_max&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order_max&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;interaction_order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span>

        <span class="k">if</span> <span class="s2">&quot;order_max_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;qoi&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;classifier&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;learning&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;classifier_options&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier_options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;loocv&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;loocv&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Changing error calculation type to loocv ...&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MEStatic_IO.run"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.MEStatic_IO.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs Multi-Element Static gPC algorithm using precomputed IO data to construct gPC approximation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        megpc : Multi-element GPC object instance</span>
<span class="sd">            MEGPC object containing all information i.e., Problem, Model, Grid, Basis, RandomParameter instances</span>
<span class="sd">        coeffs: list of ndarray of float [n_gpc][n_basis x n_out]</span>
<span class="sd">            GPC coefficients</span>
<span class="sd">        res : ndarray of float [n_grid x n_out]</span>
<span class="sd">            Simulation results at n_grid points of the n_out output variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">megpc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i_grid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i_qoi</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">q_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="n">qoi_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">i_qoi</span> <span class="o">&lt;</span> <span class="n">n_qoi</span><span class="p">:</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="n">qoi_idx</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span>
            <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;Determining gPC approximation for QOI #</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>
            <span class="n">iprint</span><span class="p">(</span><span class="n">print_str</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="n">megpc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">coeffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Create MEGPC object</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEGPC</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                 <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i_qoi</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_grid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>

            <span class="c1"># crop results to considered qoi</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
                <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">output_idx_passed_validation</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;/qoi_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>
                <span class="n">output_idx_passed_validation</span> <span class="o">=</span> <span class="n">q_idx</span>

            <span class="c1"># Write grid in gpc object</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>

            <span class="c1"># determine gpc domains</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_classifier</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                         <span class="n">results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                         <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">],</span>
                                         <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier_options&quot;</span><span class="p">])</span>

            <span class="c1"># initialize sub-gPCs</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">):</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">add_sub_gpc</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                         <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">)],</span>
                                         <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                         <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                         <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                         <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                         <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                         <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                         <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># assign grids to sub-gPCs (rotate sub-grids in case of projection)</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">assign_grids</span><span class="p">()</span>

            <span class="c1"># Initialize gpc matrices</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrices</span><span class="p">()</span>

            <span class="c1"># Compute gpc coefficients</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                               <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">],</span>
                                               <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">],</span>
                                               <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

             <span class="c1"># validate gpc approximation (determine nrmsd or loocv specified in options[&quot;error_type&quot;])</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span> <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>

            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                                <span class="n">eps</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="c1"># domain specific error</span>
            <span class="n">eps_domain</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)))]</span>
            <span class="k">for</span> <span class="n">i_gpc</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)):</span>
                <span class="n">eps_domain</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                                                      <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                      <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                      <span class="n">output_idx</span><span class="o">=</span><span class="n">output_idx_passed_validation</span><span class="p">)</span>

            <span class="c1"># save data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_session</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">]</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session_folder&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">i_gpc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;error&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">eps_domain</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">],</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">i_gpc</span><span class="p">],</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;domains&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i_gpc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                                 <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span>
                                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

            <span class="n">i_qoi</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">]</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">megpc</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span></div></div>


<div class="viewcode-block" id="StaticProjection"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.StaticProjection">[docs]</a><span class="k">class</span> <span class="nc">StaticProjection</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Static gPC algorithm using Basis Projection approach</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem : Problem object</span>
<span class="sd">        Object instance of gPC problem to investigate</span>
<span class="sd">    options[&quot;method&quot;]: str</span>
<span class="sd">        GPC method to apply [&#39;Reg&#39;, &#39;Quad&#39;]</span>
<span class="sd">    options[&quot;order&quot;]: int</span>
<span class="sd">        Expansion order, each projected variable \\eta is expanded to.</span>
<span class="sd">        Generates individual polynomials also if maximum expansion order in order_max is exceeded</span>
<span class="sd">    options[&quot;order_max&quot;]: int</span>
<span class="sd">        Maximum global expansion order.</span>
<span class="sd">        The maximum expansion order considers the sum of the orders of combined polynomials together with the</span>
<span class="sd">        chosen norm &quot;order_max_norm&quot;. Typically this norm is 1 such that the maximum order is the sum of all</span>
<span class="sd">        monomial orders.</span>
<span class="sd">    options[&quot;order_max_norm&quot;]: float</span>
<span class="sd">        Norm for which the maximum global expansion order is defined [0, 1]. Values &lt; 1 decrease the total number</span>
<span class="sd">        of polynomials in the expansion such that interaction terms are penalized more. This truncation scheme</span>
<span class="sd">        is also referred to &quot;hyperbolic polynomial chaos expansion&quot; such that sum(a_i^q)^1/q &lt;= p,</span>
<span class="sd">        where p is order_max and q is order_max_norm (for more details see eq. (27) in [1]).</span>
<span class="sd">    options[&quot;interaction_order&quot;]: int</span>
<span class="sd">        Number of random variables, which can interact with each other.</span>
<span class="sd">        All polynomials are ignored, which have an interaction order greater than the specified</span>
<span class="sd">    options[&quot;qoi&quot;] : int or str, optional, default: 0</span>
<span class="sd">        Choose for which QOI the projection is determined for. The other QOIs use the same projection.</span>
<span class="sd">        Alternatively, the projection can be determined for every QOI independently (qoi_index or &quot;all&quot;).</span>
<span class="sd">    options[&quot;n_grid&quot;] : float, optional, default: 10</span>
<span class="sd">        Number of initial grid points to determine gradient and projection matrix</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. [1] Blatman, G., &amp; Sudret, B. (2011). Adaptive sparse polynomial chaos expansion based on least angle</span>
<span class="sd">       regression. Journal of Computational Physics, 230(6), 2345-2367.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pygpc</span>
<span class="sd">    &gt;&gt;&gt; # initialize static gPC algorithm</span>
<span class="sd">    &gt;&gt;&gt; algorithm = pygpc.StaticProjection(problem=problem, options=options)</span>
<span class="sd">    &gt;&gt;&gt; # run algorithm</span>
<span class="sd">    &gt;&gt;&gt; gpc, coeffs, results = algorithm.run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes static gPC algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StaticProjection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># check contents of settings dict and set defaults</span>
        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;method&#39; with either &#39;reg&#39; or &#39;quad&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order&#39;=[order_1, order_2, ..., order_dim] in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order_max&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order_max&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;interaction_order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span>

        <span class="k">if</span> <span class="s2">&quot;order_max_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;n_grid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="s2">&quot;qoi&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="StaticProjection.run"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.StaticProjection.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs static gPC algorithm using Projection to solve problem.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gpc : GPC object instance</span>
<span class="sd">            GPC object containing all information i.e., Problem, Model, Grid, Basis, RandomParameter instances</span>
<span class="sd">        coeffs: list of ndarray of float [n_qoi][n_basis x n_out]</span>
<span class="sd">            GPC coefficients for different qoi</span>
<span class="sd">        res : ndarray of float [n_grid x n_out]</span>
<span class="sd">            Simulation results at n_grid points of the n_out output variables</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">grad_res_3D_all</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gradient_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">res_all_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">n_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid&quot;</span><span class="p">]</span>

        <span class="c1"># make initial grid to determine gradients and projection matrix. By default, it is an LHS (ese) grid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using user-predefined grid with n_grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                                 <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                                 <span class="n">coords_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                                 <span class="n">coords_gradient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                                 <span class="n">coords_gradient_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Random</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GP</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating initial grid (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) with n_grid=</span><span class="si">{</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                   <span class="n">n_grid</span><span class="o">=</span><span class="n">n_grid</span><span class="p">,</span>
                                   <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating initial grid (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) with n_grid=</span><span class="si">{</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid_original</span> <span class="o">=</span> <span class="n">LHS</span><span class="p">(</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                <span class="n">n_grid</span><span class="o">=</span><span class="n">n_grid</span><span class="p">,</span>
                                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;criterion&quot;</span><span class="p">:</span> <span class="s2">&quot;ese&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">]})</span>

        <span class="c1"># Initialize parallel Computation class</span>
        <span class="n">com</span> <span class="o">=</span> <span class="n">Computation</span><span class="p">(</span><span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">,</span> <span class="n">matlab_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matlab_model&quot;</span><span class="p">])</span>

        <span class="c1"># Set up reduced gPC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gpc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">i_grid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i_qoi</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">q_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="n">qoi_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">i_qoi</span> <span class="o">&lt;</span> <span class="n">n_qoi</span><span class="p">:</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="n">qoi_idx</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span>
            <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;Determining gPC approximation for QOI #</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>
            <span class="n">iprint</span><span class="p">(</span><span class="n">print_str</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">gpc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">coeffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">eps_pre</span> <span class="o">=</span> <span class="n">eps</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># determine gpc approximation and determine error (increase grid size in case of adaptive sampling)</span>
            <span class="k">while</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>
                <span class="c1"># run simulations</span>
                <span class="k">if</span> <span class="n">i_grid</span> <span class="o">&lt;</span> <span class="n">grid_original</span><span class="o">.</span><span class="n">n_grid</span><span class="p">:</span>
                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">{}</span><span class="s2"> simulations!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid_original</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">-</span> <span class="n">i_grid</span><span class="p">),</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                    <span class="n">res_all_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                <span class="n">coords</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:</span><span class="n">grid_original</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="p">:],</span>
                                                <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:</span><span class="n">grid_original</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="p">:],</span>
                                                <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                                <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                <span class="n">fn_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]))</span>

                    <span class="n">res_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">res_all_list</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">i_qoi</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_grid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">res_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>

                    <span class="n">i_grid</span> <span class="o">=</span> <span class="n">grid_original</span><span class="o">.</span><span class="n">n_grid</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="c1"># Determine gradient [n_grid x n_out x dim]</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                    <span class="n">grad_res_3D_all</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                 <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                                 <span class="n">grid</span><span class="o">=</span><span class="n">grid_original</span><span class="p">,</span>
                                                                 <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                                                 <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                                 <span class="n">method</span><span class="o">=</span><span class="s2">&quot;FD_fwd&quot;</span><span class="p">,</span>
                                                                 <span class="n">gradient_results_present</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">,</span>
                                                                 <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">,</span>
                                                                 <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                                                 <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                                 <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                                 <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">],</span>
                                                                 <span class="n">distance_weight</span><span class="o">=</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span>
                                                                     <span class="s2">&quot;distance_weight&quot;</span><span class="p">],</span>
                                                                 <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># crop results to considered qoi</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">res_all</span><span class="p">)</span>
                    <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>
                    <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;/qoi_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>

                <span class="c1"># Determine projection matrix</span>
                <span class="n">p_matrix</span><span class="p">,</span> <span class="n">p_matrix_complete</span> <span class="o">=</span> <span class="n">determine_projection_matrix</span><span class="p">(</span><span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:],</span>
                                                                          <span class="n">lambda_eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;lambda_eps_gradient&quot;</span><span class="p">])</span>
                <span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">dim_reduced</span> <span class="o">=</span> <span class="n">p_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">parameters_reduced</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_reduced</span><span class="p">):</span>
                    <span class="n">parameters_reduced</span><span class="p">[</span><span class="s2">&quot;n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Beta</span><span class="p">(</span><span class="n">pdf_shape</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">pdf_limits</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters_reduced</span><span class="p">)</span>

                <span class="c1"># Create reduced gPC object</span>
                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">Reg</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                                 <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_reduced</span><span class="p">)],</span>
                                 <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                 <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                 <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                 <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                 <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

                <span class="c1"># save original problem in gpc object</span>
                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span>

                <span class="c1"># save projection matrix in gPC object</span>
                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">)</span>
                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix_norm</span><span class="p">)</span>

                <span class="c1"># re-initialize grid in case of [L1, L1_LHS, LHS_L1, FIM] because initial grid was Random or LHS (ese)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">L1</span><span class="p">,</span> <span class="n">L1_LHS</span><span class="p">,</span> <span class="n">LHS_L1</span><span class="p">,</span> <span class="n">FIM</span><span class="p">]:</span>
                    <span class="n">grid_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                                         <span class="n">coords</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                                         <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                                         <span class="n">coords_gradient</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                                         <span class="n">coords_gradient_norm</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                                         <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">],</span>
                                                         <span class="n">gpc</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">])</span>

                <span class="c1"># copy grid to gPC object and initialize transformed grid</span>
                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid_original</span><span class="p">)</span>
                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">project_grid</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid_original</span><span class="p">,</span> <span class="n">p_matrix</span><span class="o">=</span><span class="n">p_matrix</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;reduce&quot;</span><span class="p">)</span>
                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>

                <span class="c1"># Initialize gpc matrix</span>
                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>

                <span class="c1"># Someone might not use the gradient to determine the gpc coeffs</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                    <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="n">grad_res_3D</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Compute gpc coefficients</span>
                <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                 <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">,</span>
                                                 <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">],</span>
                                                 <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">],</span>
                                                 <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># validate gpc approximation (determine nrmsd or loocv specified in options[&quot;error_type&quot;])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">create_validation_set</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_validation&quot;</span><span class="p">],</span>
                                                 <span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_cpu&quot;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

                <span class="n">eps</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span> <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">)</span>

                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                                    <span class="n">eps</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">eps_pre</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">):</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>
                    <span class="c1"># extend grid by 5% of number of basis functions and restart loop</span>
                    <span class="n">n_grid_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">grid_original</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">+</span> <span class="mf">5e-2</span> <span class="o">*</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">n_basis</span><span class="p">))</span>
                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Extending grid from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> by </span><span class="si">{}</span><span class="s2"> sampling points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">grid_original</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">n_grid_new</span><span class="p">,</span> <span class="n">n_grid_new</span> <span class="o">-</span> <span class="n">grid_original</span><span class="o">.</span><span class="n">n_grid</span><span class="p">),</span>
                        <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                    <span class="n">grid_original</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span><span class="n">n_grid_new</span><span class="o">=</span><span class="n">n_grid_new</span><span class="p">)</span>

                <span class="n">eps_pre</span> <span class="o">=</span> <span class="n">eps</span>

            <span class="c1"># save gpc objects and gpc coeffs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_session</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">]</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session_folder&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;error&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;p_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

            <span class="n">i_qoi</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">grid_original</span><span class="o">.</span><span class="n">coords_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">grad_res_3D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ten2mat</span><span class="p">(</span><span class="n">grad_res_3D</span><span class="p">),</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">gradient_idx</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

        <span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">gpc</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">res_all</span></div></div>


<div class="viewcode-block" id="MEStaticProjection"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.MEStaticProjection">[docs]</a><span class="k">class</span> <span class="nc">MEStaticProjection</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Static gPC algorithm using Basis Projection approach</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem : Problem object</span>
<span class="sd">        Object instance of gPC problem to investigate</span>
<span class="sd">    options[&quot;order&quot;]: int</span>
<span class="sd">        Expansion order, each projected variable \\eta is expanded to.</span>
<span class="sd">        Generates individual polynomials also if maximum expansion order in order_max is exceeded</span>
<span class="sd">    options[&quot;order_max&quot;]: int</span>
<span class="sd">        Maximum global expansion order.</span>
<span class="sd">        The maximum expansion order considers the sum of the orders of combined polynomials together with the</span>
<span class="sd">        chosen norm &quot;order_max_norm&quot;. Typically this norm is 1 such that the maximum order is the sum of all</span>
<span class="sd">        monomial orders.</span>
<span class="sd">    options[&quot;interaction_order&quot;]: int</span>
<span class="sd">        Number of random variables, which can interact with each other.</span>
<span class="sd">        All polynomials are ignored, which have an interaction order greater than the specified</span>
<span class="sd">    options[&quot;qoi&quot;] : int or str, optional, default: 0</span>
<span class="sd">        Choose for which QOI the projection is determined for. The other QOIs use the same projection.</span>
<span class="sd">        Alternatively, the projection can be determined for every QOI independently (qoi_index or &quot;all&quot;).</span>
<span class="sd">    options[&quot;n_grid_gradient&quot;] : float, optional, default: 10</span>
<span class="sd">        Number of initial grid points to determine gradient and projection matrix</span>
<span class="sd">    options[&quot;classifier&quot;] : str, optional, default: &quot;learning&quot;</span>
<span class="sd">        Classification algorithm to subdivide parameter domain.</span>
<span class="sd">        - &quot;learning&quot; ... ClassifierLearning algorithm based on Unsupervised and supervised learning</span>
<span class="sd">    options[&quot;classifier_options&quot;] : dict, optional, default: default settings</span>
<span class="sd">        Options of classifier</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. [1] Blatman, G., &amp; Sudret, B. (2011). Adaptive sparse polynomial chaos expansion based on least angle</span>
<span class="sd">       regression. Journal of Computational Physics, 230(6), 2345-2367.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pygpc</span>
<span class="sd">    &gt;&gt;&gt; # initialize static gPC algorithm</span>
<span class="sd">    &gt;&gt;&gt; algorithm = pygpc.MEStaticProjection(problem=problem, options=options)</span>
<span class="sd">    &gt;&gt;&gt; # run algorithm</span>
<span class="sd">    &gt;&gt;&gt; gpc, coeffs, results = algorithm.run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes static gPC algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MEStaticProjection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># check contents of settings dict and set defaults</span>
        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;method&#39; with either &#39;reg&#39; or &#39;quad&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order&#39;=[order_1, order_2, ..., order_dim] in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;order_max&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Please specify &#39;order_max&#39; in options dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;interaction_order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span>

        <span class="k">if</span> <span class="s2">&quot;order_max_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;n_grid_gradient&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid_gradient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="s2">&quot;qoi&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;classifier&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;learning&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;classifier_options&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier_options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="MEStaticProjection.run"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.MEStaticProjection.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs static multi-element gPC algorithm with projection.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        megpc : MEGPC object instance</span>
<span class="sd">            MEGPC object containing all information i.e., Problem, Model, Grid, Basis, RandomParameter instances</span>
<span class="sd">            and sub-gPCs</span>
<span class="sd">        coeffs: list of list of ndarray of float [n_qoi][n_gpc][n_basis x n_out]</span>
<span class="sd">            GPC coefficients of different qoi and sub-gPCs</span>
<span class="sd">        res : ndarray of float [n_grid x n_out]</span>
<span class="sd">            Simulation results at n_grid points of the n_out output variables</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">grad_res_3D_all</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gradient_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">res_all_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># make initial random grid to determine gradients and projection matrix</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using user-predefined grid with n_grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                        <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                        <span class="n">coords_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                        <span class="n">coords_gradient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                        <span class="n">coords_gradient_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                        <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Random</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LHS</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GP</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating initial grid (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) with n_grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;n_grid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                        <span class="n">n_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid&quot;</span><span class="p">],</span>
                                        <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">L1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">L1_LHS</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LHS_L1</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Grid type not possible for MEStaticProjection algorithm.&quot;</span>
                                      <span class="s2">&quot;Please use either &#39;Random&#39; or &#39;LHS&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize parallel Computation class</span>
        <span class="n">com</span> <span class="o">=</span> <span class="n">Computation</span><span class="p">(</span><span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">,</span> <span class="n">matlab_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matlab_model&quot;</span><span class="p">])</span>

        <span class="n">megpc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">i_grid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i_qoi</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">q_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="n">qoi_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">i_qoi</span> <span class="o">&lt;</span> <span class="n">n_qoi</span><span class="p">:</span>
            <span class="n">q_idx</span> <span class="o">=</span> <span class="n">qoi_idx</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span>
            <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;Determining gPC approximation for QOI #</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>
            <span class="n">iprint</span><span class="p">(</span><span class="n">print_str</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="n">megpc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">coeffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Create MEGPC object</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEGPC</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                 <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

            <span class="n">eps_pre</span> <span class="o">=</span> <span class="n">eps</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># determine gpc approximation and determine error (increase grid size in case of adaptive sampling)</span>
            <span class="k">while</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">i_grid</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">:</span>
                    <span class="c1"># run simulations</span>
                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">{}</span><span class="s2"> simulations!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">-</span> <span class="n">i_grid</span><span class="p">),</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                    <span class="n">res_all_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                <span class="n">coords</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="p">:],</span>
                                                <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="p">:],</span>
                                                <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                                <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                <span class="n">fn_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]))</span>

                    <span class="n">res_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">res_all_list</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">i_qoi</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_grid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">res_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>

                    <span class="n">i_grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="c1"># Determine gradient [n_grid x n_out x dim]</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                    <span class="n">grad_res_3D_all</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                 <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                                 <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                                                                 <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                                                 <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                                 <span class="n">method</span><span class="o">=</span><span class="s2">&quot;FD_fwd&quot;</span><span class="p">,</span>
                                                                 <span class="n">gradient_results_present</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">,</span>
                                                                 <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">,</span>
                                                                 <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                                                 <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                                 <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                                 <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">],</span>
                                                                 <span class="n">distance_weight</span><span class="o">=</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span>
                                                                     <span class="s2">&quot;distance_weight&quot;</span><span class="p">],</span>
                                                                 <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># crop results to considered qoi</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">res_all</span><span class="p">)</span>
                    <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>
                    <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">output_idx_passed_validation</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;/qoi_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>
                    <span class="n">output_idx_passed_validation</span> <span class="o">=</span> <span class="n">q_idx</span>

                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

                <span class="c1"># determine gpc domains</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_classifier</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                             <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                             <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">],</span>
                                             <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier_options&quot;</span><span class="p">])</span>

                <span class="n">problem_reduced</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                <span class="n">p_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                <span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                <span class="n">dim_reduced</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                <span class="n">parameters_reduced</span> <span class="o">=</span> <span class="p">[</span><span class="n">OrderedDict</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>

                <span class="c1"># Determine projection matrices for sub gPCs</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">):</span>
                    <span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">determine_projection_matrix</span><span class="p">(</span>
                        <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">[</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">gradient_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="n">lambda_eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;lambda_eps_gradient&quot;</span><span class="p">])</span>

                    <span class="n">p_matrix_norm</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">dim_reduced</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_reduced</span><span class="p">[</span><span class="n">d</span><span class="p">]):</span>
                        <span class="n">parameters_reduced</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Beta</span><span class="p">(</span><span class="n">pdf_shape</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">pdf_limits</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

                    <span class="n">problem_reduced</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters_reduced</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                    <span class="c1"># Set up reduced gPC for this domain</span>
                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">add_sub_gpc</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">d</span><span class="p">],</span>
                                             <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_reduced</span><span class="p">[</span><span class="n">d</span><span class="p">])],</span>
                                             <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">],</span>
                                             <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                             <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                             <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                             <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                             <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                             <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                    <span class="c1"># save original problem in gpc object</span>
                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">problem_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span>

                    <span class="c1"># save projection matrix in gPC object</span>
                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix_norm</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                <span class="c1"># copy options to MEGPC object</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>

                <span class="c1"># assign grids to sub-gPCs (rotate sub-grids in case of projection)</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">assign_grids</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>

                <span class="c1"># Initialize gpc matrices</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrices</span><span class="p">()</span>

                <span class="c1"># Someone might not use the gradient to determine the gpc coeffs</span>
                <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gradient</span><span class="p">:</span>
                    <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="n">grad_res_3D</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Compute gpc coefficients</span>
                <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                   <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">,</span>
                                                   <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">],</span>
                                                   <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">],</span>
                                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># validate gpc approximation (determine nrmsd or loocv specified in options[&quot;error_type&quot;])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">create_validation_set</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_validation&quot;</span><span class="p">],</span>
                                                   <span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_cpu&quot;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

                <span class="n">eps</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span> <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">)</span>

                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                                    <span class="n">eps</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># domain specific error</span>
                <span class="n">eps_domain</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)))]</span>
                <span class="k">for</span> <span class="n">i_gpc</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)):</span>
                    <span class="n">eps_domain</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                                                          <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                          <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                          <span class="n">output_idx</span><span class="o">=</span><span class="n">output_idx_passed_validation</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">eps_pre</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">):</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>
                    <span class="c1"># extend grid by 10% of number of grid points</span>
                    <span class="n">n_grid_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.1</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">))</span>
                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Extending grid from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> by </span><span class="si">{}</span><span class="s2"> sampling points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">n_grid_new</span><span class="p">,</span> <span class="n">n_grid_new</span> <span class="o">-</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">),</span>
                        <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                    <span class="n">grid</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span><span class="n">n_grid_new</span><span class="o">=</span><span class="n">n_grid_new</span><span class="p">)</span>

                <span class="n">eps_pre</span> <span class="o">=</span> <span class="n">eps</span>

            <span class="c1"># save data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_session</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">]</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session_folder&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">i_gpc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;error&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">eps_domain</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">],</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">i_gpc</span><span class="p">],</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;domains&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i_gpc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                                 <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span>
                                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i_gpc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;p_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
            <span class="n">i_qoi</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">]</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">grad_res_3D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ten2mat</span><span class="p">(</span><span class="n">grad_res_3D</span><span class="p">),</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">gradient_idx</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

        <span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">megpc</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="RegAdaptive"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.RegAdaptive">[docs]</a><span class="k">class</span> <span class="nc">RegAdaptive</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adaptive regression approach based on leave one out cross validation error estimation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem: Problem class instance</span>
<span class="sd">        GPC problem under investigation</span>
<span class="sd">    options[&quot;order_start&quot;] : int, optional, default=0</span>
<span class="sd">          Initial gPC expansion order (maximum order)</span>
<span class="sd">    options[&quot;order_end&quot;] : int, optional, default=10</span>
<span class="sd">        Maximum Gpc expansion order to expand to (algorithm will terminate afterwards)</span>
<span class="sd">    options[&quot;interaction_order&quot;]: int, optional, default=dim</span>
<span class="sd">        Define maximum interaction order of parameters (default: all interactions)</span>
<span class="sd">    options[&quot;order_max_norm&quot;]: float</span>
<span class="sd">        Norm for which the maximum global expansion order is defined [0, 1]. Values &lt; 1 decrease the total number</span>
<span class="sd">        of polynomials in the expansion such that interaction terms are penalized more. This truncation scheme</span>
<span class="sd">        is also referred to &quot;hyperbolic polynomial chaos expansion&quot; such that sum(a_i^q)^1/q &lt;= p,</span>
<span class="sd">        where p is order_max and q is order_max_norm (for more details see eq. (27) in [1]).</span>
<span class="sd">    options[&quot;adaptive_sampling&quot;] : boolean, optional, default: True</span>
<span class="sd">        Adds samples adaptively to the expansion until the error is converged and continues by</span>
<span class="sd">        adding new basis functions.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pygpc</span>
<span class="sd">    &gt;&gt;&gt; # initialize adaptive gPC algorithm</span>
<span class="sd">    &gt;&gt;&gt; algorithm = pygpc.RegAdaptive(problem=problem, options=options)</span>
<span class="sd">    &gt;&gt;&gt; # run algorithm</span>
<span class="sd">    &gt;&gt;&gt; gpc, coeffs, results = algorithm.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes RegAdaptive algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegAdaptive</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># check contents of settings dict and set defaults</span>
        <span class="k">if</span> <span class="s2">&quot;order_start&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;order_end&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="s2">&quot;interaction_order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dim</span>

        <span class="k">if</span> <span class="s2">&quot;order_max_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;adaptive_sampling&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;basis_increment_strategy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;basis_increment_strategy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;isotropic&quot;</span>

<div class="viewcode-block" id="RegAdaptive.run"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.RegAdaptive.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs adaptive gPC algorithm to solve problem.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gpc : GPC object instance</span>
<span class="sd">            GPC object containing all information i.e., Problem, Model, Grid, Basis, RandomParameter instances</span>
<span class="sd">        coeffs: ndarray of float [n_basis x n_out]</span>
<span class="sd">            GPC coefficients</span>
<span class="sd">        res : ndarray of float [n_grid x n_out]</span>
<span class="sd">            Simulation results at n_grid points of the n_out output variables</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># initialize iterators</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="n">i_grid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span>
        <span class="n">first_iter</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gradient_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">grad_res_3D_FD_fwd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">basis_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                                <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">])])</span>

        <span class="c1"># Initialize parallel Computation class</span>
        <span class="n">com</span> <span class="o">=</span> <span class="n">Computation</span><span class="p">(</span><span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">,</span> <span class="n">matlab_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matlab_model&quot;</span><span class="p">])</span>

        <span class="c1"># Initialize Reg gPC object</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing gPC object...&quot;</span><span class="p">)</span>
        <span class="n">gpc</span> <span class="o">=</span> <span class="n">Reg</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                  <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
                  <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                  <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                  <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                  <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                  <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                  <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>
        <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Add a validation set if nrmsd is chosen and no validation set is yet present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">,</span> <span class="n">ValidationSet</span><span class="p">):</span>
            <span class="n">gpc</span><span class="o">.</span><span class="n">create_validation_set</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_validation&quot;</span><span class="p">],</span>
                                      <span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_cpu&quot;</span><span class="p">])</span>

        <span class="c1"># Initialize Grid object</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using user-predefined grid with n_grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                            <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                            <span class="n">coords_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                            <span class="n">coords_gradient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                            <span class="n">coords_gradient_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_grid_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matrix_ratio&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">gpc</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">n_basis</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating initial grid (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) with n_grid=</span><span class="si">{</span><span class="n">n_grid_init</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">L1</span><span class="p">,</span> <span class="n">L1_LHS</span><span class="p">,</span> <span class="n">LHS_L1</span><span class="p">,</span> <span class="n">FIM</span><span class="p">,</span> <span class="n">CO</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s2">&quot;n_pool&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">][</span><span class="s2">&quot;n_pool&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_grid_init</span><span class="p">):</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;self.options[&quot;grid_options&quot;][&quot;n_pool&quot;] &lt; n_grid_init ... setting n_pool to 2*n_grid_init&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">][</span><span class="s2">&quot;n_pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">n_grid_init</span><span class="p">)</span>

                <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                                <span class="n">n_grid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n_grid_init</span><span class="p">),</span>
                                                <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">],</span>
                                                <span class="n">gpc</span><span class="o">=</span><span class="n">gpc</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                                <span class="n">n_grid</span><span class="o">=</span><span class="n">n_grid_init</span><span class="p">,</span>
                                                <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>

        <span class="n">gpc</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>
        <span class="n">gpc</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span>
        <span class="n">gpc</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># Initialize gpc matrix</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing gPC matrix...&quot;</span><span class="p">)</span>
        <span class="n">gpc</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>
        <span class="n">gpc</span><span class="o">.</span><span class="n">n_grid</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">gpc</span><span class="o">.</span><span class="n">n_basis</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
            <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">create_gradient_grid</span><span class="p">()</span>

        <span class="c1"># Main iterations (order)</span>
        <span class="n">i_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>

            <span class="k">if</span> <span class="n">first_iter</span><span class="p">:</span>
                <span class="n">basis_increment</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basis_increment</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;basis_increment_strategy&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;anisotropic&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">first_iter</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gpc</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">multi_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_end&quot;</span><span class="p">]:</span>
                        <span class="k">break</span>

                    <span class="c1"># determine potential polynomials which can be extended</span>
                    <span class="c1"># (not enclosed by other already existing polynomials)</span>
                    <span class="n">active_non_enclosed_set</span><span class="p">,</span> <span class="n">poly_indices_non_enclosed</span> <span class="o">=</span> <span class="n">get_non_enclosed_multi_indices</span><span class="p">(</span>
                        <span class="n">multi_indices</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">multi_indices</span><span class="p">,</span>
                        <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">])</span>

                    <span class="c1"># get index of highest non enclosed coefficient</span>
                    <span class="n">coeff_max_idx_non_enclosed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">poly_indices_non_enclosed</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

                    <span class="c1"># determine multi-indices to add</span>
                    <span class="n">multi_indices_to_add</span> <span class="o">=</span> <span class="n">poly_expand</span><span class="p">(</span><span class="n">current_set</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">multi_indices</span><span class="p">,</span>
                                                       <span class="n">to_expand</span><span class="o">=</span><span class="n">active_non_enclosed_set</span><span class="p">[</span><span class="n">coeff_max_idx_non_enclosed</span><span class="p">],</span>
                                                       <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_end&quot;</span><span class="p">],</span>
                                                       <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">])</span>

                    <span class="c1"># update basis</span>
                    <span class="n">b_added</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">add_basis_poly_by_order</span><span class="p">(</span><span class="n">multi_indices</span><span class="o">=</span><span class="n">multi_indices_to_add</span><span class="p">,</span>
                                                                <span class="n">problem</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">problem</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">b_added</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">print_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Added multi-indices to basis: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">multi_indices_to_add</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">iprint</span><span class="p">(</span><span class="n">print_str</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                        <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                        <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># increase basis isotropic</span>
                <span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">increment_basis</span><span class="p">(</span><span class="n">order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                 <span class="n">interaction_order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                 <span class="n">interaction_order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                                 <span class="n">incr</span><span class="o">=</span><span class="n">basis_increment</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_end&quot;</span><span class="p">]:</span>
                    <span class="k">break</span>

                <span class="c1"># update basis</span>
                <span class="n">b_added</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">set_basis_poly</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
                                                   <span class="n">order_max</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                                   <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                   <span class="n">interaction_order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">problem</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">problem</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">b_added</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;Order/Interaction order: </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">iprint</span><span class="p">(</span><span class="n">print_str</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                    <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># plot basis</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;plot_basis&quot;</span><span class="p">]:</span>
                <span class="n">gpc</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">plot_basis</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">gpc</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="mi">3</span><span class="p">))),</span>
                                     <span class="n">fn_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_basis_</span><span class="si">{</span><span class="n">i_iter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">i_iter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Starting adaptive sampling:&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="n">add_samples</span> <span class="o">=</span> <span class="kc">True</span>   <span class="c1"># if adaptive sampling is False, the while loop will be only executed once</span>
            <span class="n">delta_eps_target</span> <span class="o">=</span> <span class="mf">1e-1</span>
            <span class="n">delta_eps</span> <span class="o">=</span> <span class="n">delta_eps_target</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">delta_samples</span> <span class="o">=</span> <span class="mf">5e-2</span>

            <span class="k">while</span> <span class="n">add_samples</span> <span class="ow">and</span> <span class="n">delta_eps</span> <span class="o">&gt;</span> <span class="n">delta_eps_target</span> <span class="ow">and</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                    <span class="n">add_samples</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># new sample size</span>
                <span class="k">if</span> <span class="n">extended_basis</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                    <span class="c1"># do not increase sample size immediately when basis was extended, try first with old samples</span>
                    <span class="n">n_grid_new</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">first_iter</span><span class="p">:</span>
                    <span class="c1"># increase sample size stepwise (adaptive sampling)</span>
                    <span class="n">n_grid_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">+</span> <span class="n">delta_samples</span> <span class="o">*</span> <span class="n">gpc</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">n_basis</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># increase sample size according to matrix ratio w.r.t. number of basis functions</span>
                    <span class="n">n_grid_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">gpc</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">n_basis</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matrix_ratio&quot;</span><span class="p">]))</span>

                <span class="c1"># run model if grid points were added</span>
                <span class="k">if</span> <span class="n">i_grid</span> <span class="o">&lt;</span> <span class="n">n_grid_new</span> <span class="ow">or</span> <span class="n">extended_basis</span><span class="p">:</span>
                    <span class="c1"># extend grid</span>
                    <span class="k">if</span> <span class="n">i_grid</span> <span class="o">&lt;</span> <span class="n">n_grid_new</span><span class="p">:</span>
                        <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Extending grid from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> by </span><span class="si">{}</span><span class="s2"> sampling points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">n_grid_new</span><span class="p">,</span> <span class="n">n_grid_new</span> <span class="o">-</span> <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">),</span>
                            <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">L1</span><span class="p">,</span> <span class="n">L1_LHS</span><span class="p">,</span> <span class="n">LHS_L1</span><span class="p">,</span> <span class="n">FIM</span><span class="p">,</span> <span class="n">CO</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="s2">&quot;n_pool&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">][</span><span class="s2">&quot;n_pool&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_grid_init</span><span class="p">):</span>
                                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                        <span class="s1">&#39;self.options[&quot;grid_options&quot;][&quot;n_pool&quot;] &lt; n_grid_new ... &#39;</span>
                                        <span class="s1">&#39;setting n_pool to 2*n_grid_new&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">][</span><span class="s2">&quot;n_pool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_grid_new</span><span class="p">)</span>

                        <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span><span class="n">n_grid_new</span><span class="o">=</span><span class="n">n_grid_new</span><span class="p">)</span>

                        <span class="c1"># run simulations</span>
                        <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing simulations &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_grid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                               <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                        <span class="n">res_new</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                          <span class="n">problem</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                          <span class="n">coords</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i_grid</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">))],</span>
                                          <span class="n">coords_norm</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i_grid</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">))],</span>
                                          <span class="n">i_iter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">i_subiter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">fn_results</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">fn_results</span><span class="p">,</span>
                                          <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                          <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                        <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total parallel function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                               <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                        <span class="c1"># Append result to solution matrix (RHS)</span>
                        <span class="k">if</span> <span class="n">i_grid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">res_new</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="n">res_new</span><span class="p">])</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                            <span class="n">grad_res_3D</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                     <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                                     <span class="n">grid</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span>
                                                                     <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                                     <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                                     <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">],</span>
                                                                     <span class="n">gradient_results_present</span><span class="o">=</span><span class="n">grad_res_3D_FD_fwd</span><span class="p">,</span>
                                                                     <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="n">gradient_idx_FD_fwd</span><span class="p">,</span>
                                                                     <span class="n">i_iter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                     <span class="n">i_subiter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                     <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                                     <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">],</span>
                                                                     <span class="n">distance_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;distance_weight&quot;</span><span class="p">],</span>
                                                                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FD_fwd&quot;</span><span class="p">:</span>
                                <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="n">gradient_idx</span>
                                <span class="n">grad_res_3D_FD_fwd</span> <span class="o">=</span> <span class="n">grad_res_3D</span>

                            <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                                   <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                        <span class="n">i_grid</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># update gpc matrix</span>
                    <span class="n">gpc</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>

                    <span class="c1"># determine gpc coefficients</span>
                    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                       <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D</span><span class="p">,</span>
                                       <span class="n">solver</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
                                       <span class="n">settings</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="c1"># validate gpc approximation (determine nrmsd or loocv specified in options[&quot;error_type&quot;])</span>
                    <span class="n">eps</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span>
                                       <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                       <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">extended_basis</span><span class="p">:</span>
                        <span class="n">eps_ref</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">delta_eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">gpc</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">gpc</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">eps_ref</span><span class="p">)</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                                        <span class="n">eps</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="c1"># extend basis further if error was decreased (except in very first iteration)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">first_iter</span> <span class="ow">and</span> <span class="n">extended_basis</span> <span class="ow">and</span> <span class="n">gpc</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">gpc</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="k">break</span>

                    <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">first_iter</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># exit adaptive sampling loop if no adaptive sampling was chosen</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                        <span class="k">break</span>

            <span class="c1"># save gpc coeffs for this sub-iteration</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                    <span class="c1"># overwrite coeffs</span>
                    <span class="k">if</span> <span class="s2">&quot;coeffs&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;coeffs&#39;</span><span class="p">]</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="c1"># Append gradient of results</span>
                    <span class="k">if</span> <span class="n">grad_res_3D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">grad_res_2D</span> <span class="o">=</span> <span class="n">ten2mat</span><span class="p">(</span><span class="n">grad_res_3D</span><span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">]</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="n">grad_res_2D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grad_res_2D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                         <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">grad_res_2D</span><span class="p">)</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gradient_idx</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix&quot;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

        <span class="c1"># determine gpc coefficients</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">gpc</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                           <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D</span><span class="p">,</span>
                           <span class="n">solver</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
                           <span class="n">settings</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="c1"># save gpc object and gpc coeffs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;coeffs&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;coeffs&#39;</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span><span class="p">,</span>
                                 <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="c1"># misc</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">,</span>
                                 <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session_folder&quot;</span><span class="p">,</span>
                                 <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

        <span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">gpc</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="MERegAdaptiveProjection"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.MERegAdaptiveProjection">[docs]</a><span class="k">class</span> <span class="nc">MERegAdaptiveProjection</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adaptive regression approach based on leave one out cross validation error estimation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem: Problem class instance</span>
<span class="sd">        GPC problem under investigation</span>
<span class="sd">    options[&quot;order_start&quot;] : int, optional, default=0</span>
<span class="sd">          Initial gPC expansion order (maximum order)</span>
<span class="sd">    options[&quot;order_end&quot;] : int, optional, default=10</span>
<span class="sd">        Maximum Gpc expansion order to expand to (algorithm will terminate afterwards)</span>
<span class="sd">    options[&quot;interaction_order&quot;]: int, optional, default=dim</span>
<span class="sd">        Define maximum interaction order of parameters (default: all interactions)</span>
<span class="sd">    options[&quot;order_max_norm&quot;]: float</span>
<span class="sd">        Norm for which the maximum global expansion order is defined [0, 1]. Values &lt; 1 decrease the total number</span>
<span class="sd">        of polynomials in the expansion such that interaction terms are penalized more. This truncation scheme</span>
<span class="sd">        is also referred to &quot;hyperbolic polynomial chaos expansion&quot; such that sum(a_i^q)^1/q &lt;= p,</span>
<span class="sd">        where p is order_max and q is order_max_norm (for more details see eq. (27) in [1]).</span>
<span class="sd">    options[&quot;adaptive_sampling&quot;] : boolean, optional, default: True</span>
<span class="sd">        Adds samples adaptively to the expansion until the error is converged and continues by</span>
<span class="sd">        adding new basis functions.</span>
<span class="sd">    options[&quot;n_samples_discontinuity&quot;] : int, optional, default: 10</span>
<span class="sd">        Number of grid points close to discontinuity to refine its location</span>
<span class="sd">    options[&quot;n_grid_init&quot;] : int, optional, default: 10</span>
<span class="sd">        Number of initial simulations to explore the parameter space</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pygpc</span>
<span class="sd">    &gt;&gt;&gt; # initialize adaptive gPC algorithm</span>
<span class="sd">    &gt;&gt;&gt; algorithm = pygpc.MERegAdaptiveProjection(problem=problem, options=options)</span>
<span class="sd">    &gt;&gt;&gt; # run algorithm</span>
<span class="sd">    &gt;&gt;&gt; gpc, coeffs, results = algorithm.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes MERegAdaptiveProjection Algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MERegAdaptiveProjection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># check contents of settings dict and set defaults</span>
        <span class="k">if</span> <span class="s2">&quot;order_start&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;order_end&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="s2">&quot;interaction_order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dim</span>

        <span class="k">if</span> <span class="s2">&quot;order_max_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;adaptive_sampling&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;n_samples_discontinuity&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_discontinuity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="s2">&quot;n_grid_init&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid_init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="MERegAdaptiveProjection.run"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.MERegAdaptiveProjection.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs Multi-Element adaptive gPC algorithm to solve problem (optional projection).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        megpc : Multi-element GPC object instance</span>
<span class="sd">            MEGPC object containing all information i.e., Problem, Model, Grid, Basis, RandomParameter instances</span>
<span class="sd">        coeffs: list of ndarray of float [n_gpc][n_basis x n_out]</span>
<span class="sd">            GPC coefficients</span>
<span class="sd">        res : ndarray of float [n_grid x n_out]</span>
<span class="sd">            Simulation results at n_grid points of the n_out output variables</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span>
        <span class="n">problem_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">)</span>

        <span class="c1"># initialize iterators</span>
        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">grad_res_3D_all</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gradient_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">basis_increment</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">n_grid_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid_init&quot;</span><span class="p">]</span>

        <span class="c1"># make initial random grid to determine number of output variables and to estimate projection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using user-predefined grid with n_grid=</span><span class="si">{</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                 <span class="n">coords</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                 <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                 <span class="n">coords_gradient</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                 <span class="n">coords_gradient_norm</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Random</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LHS</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GP</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating initial grid (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) with n_grid=</span><span class="si">{</span><span class="n">n_grid_init</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                        <span class="n">n_grid</span><span class="o">=</span><span class="n">n_grid_init</span><span class="p">,</span>
                                        <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">L1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">L1_LHS</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LHS_L1</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FIM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Grid type not possible for MERegAdaptiveProjection algorithm.&quot;</span>
                                      <span class="s2">&quot;Please use either &#39;Random&#39;, &#39;LHS&#39; or &#39;GP&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize parallel Computation class</span>
        <span class="n">com</span> <span class="o">=</span> <span class="n">Computation</span><span class="p">(</span><span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">,</span> <span class="n">matlab_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matlab_model&quot;</span><span class="p">])</span>

        <span class="c1"># Run initial simulations to determine initial projection matrix</span>
        <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">{}</span><span class="s2"> initial simulations!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
               <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">res_all</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                          <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                          <span class="n">coords</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                          <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                          <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                          <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                          <span class="n">fn_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">],</span>  <span class="c1"># + &quot;_temp&quot;</span>
                          <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="n">i_grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span>

        <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
               <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">res_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qoi</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]]</span>
            <span class="n">n_qoi</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Determine gradient for projection [n_grid x n_out x dim]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FD_fwd&quot;</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;FD_fwd&quot;</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="mf">1e-3</span>
                <span class="n">distance_weight</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">]</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span>
                <span class="n">distance_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;distance_weight&quot;</span><span class="p">]</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">grad_res_3D_all</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                         <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                         <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                                                         <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                                         <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                         <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                                         <span class="n">gradient_results_present</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                         <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                         <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                                                         <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                         <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                         <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span>
                                                         <span class="n">distance_weight</span><span class="o">=</span><span class="n">distance_weight</span><span class="p">,</span>
                                                         <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;FD_fwd&quot;</span><span class="p">:</span>
                <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="n">gradient_idx</span>
                <span class="n">grad_res_3D_all_FD_fwd</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">grad_res_3D_all_FD_fwd</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                   <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="n">megpc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qoi</span><span class="p">)]</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qoi</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i_qoi</span><span class="p">,</span> <span class="n">q_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">):</span>
            <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;Determining gPC approximation for QOI #</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>
            <span class="n">iprint</span><span class="p">(</span><span class="n">print_str</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="n">first_iter</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># crop results to considered qoi</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">res_all</span><span class="p">)</span>
                <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>
                <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">output_idx_passed_validation</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># the gPC is constructed for all QOI but only using info for projection etc of desired QOI</span>
                <span class="c1"># validation is done for all qoi</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;/qoi_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>
                <span class="n">output_idx_passed_validation</span> <span class="o">=</span> <span class="n">q_idx</span>

                <span class="k">if</span> <span class="n">grad_res_3D_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># Create MEGPC object</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEGPC</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                 <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

            <span class="c1"># Write grid in gpc object</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

            <span class="c1"># determine gpc domains</span>
            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Determining gPC domains ...&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_classifier</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                         <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                         <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">],</span>
                                         <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier_options&quot;</span><span class="p">])</span>

            <span class="n">error</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">domains</span><span class="p">)))]</span>
            <span class="n">p_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
            <span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
            <span class="n">parameters</span><span class="o">=</span> <span class="p">[</span><span class="n">OrderedDict</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
            <span class="n">problem</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
            <span class="n">basis_order</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">n_grid_reinit</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>

            <span class="c1"># determine initial projection and initialize sub-gPCs</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">):</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]:</span>
                    <span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">determine_projection_matrix</span><span class="p">(</span>
                        <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">[</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">gradient_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="n">lambda_eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;lambda_eps_gradient&quot;</span><span class="p">])</span>

                    <span class="n">p_matrix_norm</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">]):</span>
                        <span class="n">parameters</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Beta</span><span class="p">(</span><span class="n">pdf_shape</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">pdf_limits</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

                    <span class="n">problem</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">p_matrix_norm</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_original</span><span class="o">.</span><span class="n">dim</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_original</span><span class="o">.</span><span class="n">parameters_random</span>
                    <span class="n">problem</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">problem_original</span><span class="p">)</span>

                <span class="c1"># Set up reduced gPC for this domain</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">add_sub_gpc</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">[</span><span class="n">d</span><span class="p">],</span>
                                         <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">])],</span>
                                         <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                                         <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                         <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                         <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                         <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                         <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                         <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                <span class="c1"># save original problem in gpc object</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">problem_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">problem_original</span><span class="p">)</span>

                <span class="c1"># save projection matrix in gPC object</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix_norm</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                <span class="c1"># initialize dict containing approximation orders of sub-gPCs [order, interaction_order_current]</span>
                <span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]])</span>

                <span class="c1"># initialize solver settings</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span>

                <span class="c1"># extend initial grid and perform additional simulations if necessary</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;Moore-Penrose&quot;</span><span class="p">:</span>
                    <span class="n">n_coeffs</span> <span class="o">=</span> <span class="n">get_num_coeffs_sparse</span><span class="p">(</span>
                        <span class="n">order_dim_max</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">])],</span>
                        <span class="n">order_glob_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                        <span class="n">order_inter_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                        <span class="n">order_inter_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                        <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                    <span class="n">n_grid_reinit</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_coeffs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matrix_ratio&quot;</span><span class="p">]</span>

                <span class="c1"># Check if we have enough samples in this particular domain for the given order we start</span>
                <span class="k">if</span> <span class="n">n_grid_reinit</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span> <span class="o">==</span> <span class="n">d</span><span class="p">):</span>

                    <span class="c1"># extend random grid</span>
                    <span class="n">grid</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span><span class="n">n_grid_new</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span> <span class="o">==</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_grid_reinit</span><span class="p">[</span><span class="n">d</span><span class="p">],</span>
                                            <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>

                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">&gt;</span> <span class="n">i_grid</span><span class="p">:</span>

                <span class="c1"># Run some more initial simulations</span>
                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">{}</span><span class="s2"> more initial simulations &quot;</span>
                       <span class="s2">&quot;to fulfil order constraint!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">-</span> <span class="n">i_grid</span><span class="p">),</span>
                       <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="n">res_new</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                  <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                  <span class="n">coords</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:,</span> <span class="p">],</span>
                                  <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:,</span> <span class="p">],</span>
                                  <span class="n">i_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">i_subiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">fn_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">],</span>
                                  <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># add results to results array</span>
                <span class="n">res_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">res_all</span><span class="p">,</span> <span class="n">res_new</span><span class="p">))</span>
                <span class="n">i_grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span>

                <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                       <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># Determine gradient [n_grid x n_out x dim]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FD_fwd&quot;</span><span class="p">:</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;FD_fwd&quot;</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="mf">1e-3</span>
                        <span class="n">distance_weight</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">]</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span>
                        <span class="n">distance_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;distance_weight&quot;</span><span class="p">]</span>

                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                    <span class="n">grad_res_3D_all</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                 <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                                 <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                                                                 <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                                                 <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                                 <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                                                 <span class="n">gradient_results_present</span><span class="o">=</span><span class="n">grad_res_3D_all_FD_fwd</span><span class="p">,</span>
                                                                 <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="n">gradient_idx_FD_fwd</span><span class="p">,</span>
                                                                 <span class="n">i_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                 <span class="n">i_subiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                 <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                                 <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span>
                                                                 <span class="n">distance_weight</span><span class="o">=</span><span class="n">distance_weight</span><span class="p">,</span>
                                                                 <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;FD_fwd&quot;</span><span class="p">:</span>
                        <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="n">gradient_idx</span>
                        <span class="n">grad_res_3D_all_FD_fwd</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">grad_res_3D_all_FD_fwd</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

                <span class="c1"># update classifier</span>
                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Updating classifier ...&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">update_classifier</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                               <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

            <span class="c1"># create validation set if necessary</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Determining validation set of size </span><span class="si">{}</span><span class="s2"> &quot;</span>
                       <span class="s2">&quot;for NRMSD error calculation ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_validation&quot;</span><span class="p">])),</span>
                       <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">create_validation_set</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_validation&quot;</span><span class="p">],</span>
                                               <span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_cpu&quot;</span><span class="p">],</span>
                                               <span class="n">gradient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">])</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

            <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># initialize domain specific error</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)])</span>

            <span class="c1"># Main iterations (order)</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>

                <span class="n">stop_by_order</span> <span class="o">=</span> <span class="p">[(</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">==</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_end&quot;</span><span class="p">],</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">for</span>
                                 <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                <span class="n">stop_by_error</span> <span class="o">=</span> <span class="n">eps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span>

                <span class="c1"># print(&quot;stop_by_order: {}&quot;.format(stop_by_order))</span>
                <span class="c1"># print(&quot;stop_by_error: {}&quot;.format(stop_by_error))</span>
                <span class="c1"># print(&quot;eps: {}&quot;.format(eps))</span>

                <span class="c1"># TODO: ValueError: operands could not be broadcast together with shapes (2,) (3,)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">stop_by_order</span><span class="p">,</span> <span class="n">stop_by_error</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="k">break</span>

                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Refining domain boundary ...&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># determine grid points close to discontinuity</span>
                <span class="n">coords_norm_disc</span> <span class="o">=</span> <span class="n">get_coords_discontinuity</span><span class="p">(</span><span class="n">classifier</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span>
                                                            <span class="n">x_min</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">)],</span>
                                                            <span class="n">x_max</span><span class="o">=</span><span class="p">[</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">)],</span>
                                                            <span class="n">n_coords_disc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_discontinuity&quot;</span><span class="p">],</span>
                                                            <span class="n">border_sampling</span><span class="o">=</span><span class="s2">&quot;structured&quot;</span><span class="p">)</span>

                <span class="n">coords_disc</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_denormalized_coordinates</span><span class="p">(</span><span class="n">coords_norm_disc</span><span class="p">)</span>

                <span class="c1"># add grid points close to discontinuity to global grid</span>
                <span class="n">grid</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords_disc</span><span class="p">,</span>
                                        <span class="n">coords_norm</span><span class="o">=</span><span class="n">coords_norm_disc</span><span class="p">,</span>
                                        <span class="n">gradient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">])</span>

                <span class="c1"># run simulations close to discontinuity</span>
                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">{}</span><span class="s2"> simulations to refine discontinuity location!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_discontinuity&quot;</span><span class="p">]),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="n">res_disc</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                   <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                   <span class="n">coords</span><span class="o">=</span><span class="n">coords_disc</span><span class="p">,</span>
                                   <span class="n">coords_norm</span><span class="o">=</span><span class="n">coords_norm_disc</span><span class="p">,</span>
                                   <span class="n">i_iter</span><span class="o">=</span><span class="s2">&quot;Domain boundary&quot;</span><span class="p">,</span>
                                   <span class="n">i_subiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">fn_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">],</span>
                                   <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                       <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># add results to results array</span>
                <span class="n">res_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">res_all</span><span class="p">,</span> <span class="n">res_disc</span><span class="p">))</span>

                <span class="c1"># Determine gradient [n_grid x n_out x dim]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]:</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                    <span class="n">grad_res_3D_all</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                 <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                                 <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                                                                 <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                                                 <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                                 <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">],</span>
                                                                 <span class="n">gradient_results_present</span><span class="o">=</span><span class="n">grad_res_3D_all_FD_fwd</span><span class="p">,</span>
                                                                 <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="n">gradient_idx_FD_fwd</span><span class="p">,</span>
                                                                 <span class="n">i_iter</span><span class="o">=</span><span class="s2">&quot;Domain boundary&quot;</span><span class="p">,</span>
                                                                 <span class="n">i_subiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                 <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                                 <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">],</span>
                                                                 <span class="n">distance_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;distance_weight&quot;</span><span class="p">],</span>
                                                                 <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FD_fwd&quot;</span><span class="p">:</span>
                        <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="n">gradient_idx</span>
                        <span class="n">grad_res_3D_all_FD_fwd</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="n">i_grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span>

                <span class="c1"># crop results to considered qoi</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">res_all</span><span class="p">)</span>
                    <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">grad_res_3D_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

                <span class="c1"># Write grid in gpc object</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

                <span class="c1"># update classifier</span>
                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Updating classifier ...&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">update_classifier</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                               <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

                <span class="c1"># update sub-gPCs if number of domains changed</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">):</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;New domains found! Updating number of sub-gPCs from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span>
                           <span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">))),</span>
                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_classifier</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                                 <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                                 <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">],</span>
                                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;classifier_options&quot;</span><span class="p">])</span>

                    <span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span>
                    <span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span>

                    <span class="c1"># eps = np.hstack((eps, np.array(self.options[&quot;eps&quot;] + 1)))</span>
                    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)))])</span>

                    <span class="k">for</span> <span class="n">i_gpc</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)):</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">add_sub_gpc</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem_original</span><span class="p">,</span>
                                                 <span class="n">order</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
                                                 <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                                                 <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                                 <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                 <span class="n">interaction_order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span>
                                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                                 <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                 <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                        <span class="c1"># save original problem in gpc object</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">problem_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">problem_original</span><span class="p">)</span>

                        <span class="c1"># initialize domain specific interaction order and other settings</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_gpc</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span>

                <span class="c1"># update projection matrices</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]:</span>
                    <span class="n">p_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                    <span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">OrderedDict</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>
                    <span class="n">problem</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">)]</span>

                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">):</span>
                        <span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">determine_projection_matrix</span><span class="p">(</span>
                            <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">[</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">gradient_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:],</span>
                            <span class="n">lambda_eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;lambda_eps_gradient&quot;</span><span class="p">])</span>

                        <span class="n">p_matrix_norm</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">]):</span>
                            <span class="n">parameters</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Beta</span><span class="p">(</span><span class="n">pdf_shape</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">pdf_limits</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

                        <span class="n">problem</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                        <span class="c1"># replace sub-gpc with the one containing the reduced problem</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">add_sub_gpc</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">[</span><span class="n">d</span><span class="p">],</span>
                                                 <span class="n">order</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span>
                                                 <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                                                 <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                                 <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                 <span class="n">interaction_order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span>
                                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                                 <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                 <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                        <span class="c1"># save original problem in gpc object</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">problem_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">problem_original</span><span class="p">)</span>

                        <span class="c1"># save projection matrix in gPC object</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix_norm</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                        <span class="c1"># initialize domain specific interaction order and other settings</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>
                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span>

                <span class="c1"># update gpc approximation with new grid points close to discontinuity</span>
                <span class="c1"># assign grids to sub-gPCs (rotate sub-grids in case of projection)</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">assign_grids</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>

                <span class="c1"># Initialize gpc matrices</span>
                <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrices</span><span class="p">()</span>

                <span class="c1"># Compute gpc coefficients</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                    <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="n">grad_res_3D</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                   <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">,</span>
                                                   <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">],</span>
                                                   <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">],</span>
                                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># domain specific error</span>
                <span class="k">for</span> <span class="n">i_gpc</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)):</span>
                    <span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                                                   <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                   <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                   <span class="n">output_idx</span><span class="o">=</span><span class="n">output_idx_passed_validation</span><span class="p">)</span>
                    <span class="n">error</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; Domain: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                               <span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="c1"># loop over domains and increase order if necessary</span>
                <span class="k">for</span> <span class="n">i_gpc</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)):</span>

                    <span class="n">skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="o">==</span>
                            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_end&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>

                        <span class="c1"># increase basis by 1 interaction order</span>
                        <span class="n">order_new</span> <span class="o">=</span> <span class="n">increment_basis</span><span class="p">(</span><span class="n">order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">interaction_order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">interaction_order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                    <span class="n">incr</span><span class="o">=</span><span class="n">basis_increment</span><span class="p">)</span>

                        <span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">order_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">order_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;Domain: </span><span class="si">{}</span><span class="s2">, Order: #</span><span class="si">{}</span><span class="s2">, Sub-iteration: #</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">d</span><span class="p">,</span>
                            <span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">])</span>

                        <span class="n">iprint</span><span class="p">(</span><span class="n">print_str</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                        <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                        <span class="c1"># update basis</span>
                        <span class="n">b_added</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">set_basis_poly</span><span class="p">(</span>
                            <span class="n">order</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span>
                            <span class="n">order_max</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                            <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                            <span class="n">interaction_order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                        <span class="c1"># continue algorithm if no basis function was added because of max norm constraint</span>
                        <span class="k">if</span> <span class="n">b_added</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="c1"># iprint(&quot;-&gt; Domain: {} {} {} &quot;</span>
                            <span class="c1">#        &quot;error = {}&quot;.format(d,</span>
                            <span class="c1">#                            self.options[&quot;error_norm&quot;],</span>
                            <span class="c1">#                            self.options[&quot;error_type&quot;],</span>
                            <span class="c1">#                            eps[d]), tab=0, verbose=self.options[&quot;verbose&quot;])</span>
                            <span class="c1"># iprint(&quot;-&gt; No basis functions to add in domain {} ... Continuing ... &quot;.format(d),</span>
                            <span class="c1">#        tab=0, verbose=self.options[&quot;verbose&quot;])</span>
                            <span class="k">continue</span>

                        <span class="c1"># update gpc matrix</span>
                        <span class="n">gradient_idx_gpc</span> <span class="o">=</span> <span class="n">get_gradient_idx_domain</span><span class="p">(</span><span class="n">domains</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">,</span>
                                                                   <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                                   <span class="n">gradient_idx</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gradient_idx</span><span class="p">)</span>

                        <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx_gpc</span><span class="p">)</span>

                        <span class="c1"># determine gpc coefficients with new basis but old samples</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                            <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="n">grad_res_3D</span><span class="p">[</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">gradient_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span> <span class="o">==</span> <span class="n">d</span><span class="p">,</span> <span class="p">],</span>
                                                                     <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">,</span>
                                                                     <span class="n">solver</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
                                                                     <span class="n">settings</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                                                                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                        <span class="c1"># Add samples</span>
                        <span class="n">add_samples</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># if adaptive sampling is False, the loop will be only executed once</span>
                        <span class="n">delta_eps_target</span> <span class="o">=</span> <span class="mf">1e-1</span>
                        <span class="n">delta_eps</span> <span class="o">=</span> <span class="n">delta_eps_target</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">delta_samples</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mf">5e-2</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Starting adaptive sampling:&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                        <span class="c1"># only increase samples if error increased and until error converges again</span>
                        <span class="k">while</span> <span class="n">add_samples</span> <span class="ow">and</span> <span class="n">delta_eps</span> <span class="o">&gt;</span> <span class="n">delta_eps_target</span> <span class="ow">and</span> <span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                                <span class="n">add_samples</span> <span class="o">=</span> <span class="kc">False</span>

                            <span class="c1"># new sample size</span>
                            <span class="k">if</span> <span class="n">extended_basis</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                                <span class="c1"># do not increase sample size immediately when basis was extended</span>
                                <span class="c1"># try first with old samples</span>
                                <span class="n">n_grid_new</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">first_iter</span><span class="p">:</span>
                                <span class="c1"># increase sample size stepwise (adaptive sampling)</span>
                                <span class="n">n_grid_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">+</span>
                                                         <span class="n">delta_samples</span> <span class="o">*</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">n_basis</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># increase sample size according to matrix ratio w.r.t. number of basis functions</span>
                                <span class="n">n_grid_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">n_basis</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matrix_ratio&quot;</span><span class="p">]))</span>

                            <span class="c1"># run model if grid points were added</span>
                            <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">&lt;</span> <span class="n">n_grid_new</span> <span class="ow">or</span> <span class="n">extended_basis</span><span class="p">:</span>
                                <span class="c1"># extend grid</span>
                                <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">&lt;</span> <span class="n">n_grid_new</span><span class="p">:</span>
                                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Extending grid in domain </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> by </span><span class="si">{}</span><span class="s2"> sampling points &quot;</span>
                                           <span class="s2">&quot;(global grid: </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">n_grid_new</span><span class="p">,</span>
                                                                      <span class="n">n_grid_new</span> <span class="o">-</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span>
                                                                      <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">),</span>
                                           <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                    <span class="c1"># add grid points in this domain to global grid</span>
                                    <span class="n">grid</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span>
                                        <span class="n">n_grid_new</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">-</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">+</span> <span class="n">n_grid_new</span><span class="p">,</span>
                                        <span class="n">classifier</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span>
                                        <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                        <span class="n">gradient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">])</span>

                                    <span class="c1"># run simulations</span>
                                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing simulations </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">i_grid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                        <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                                    <span class="n">res_new</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                      <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                      <span class="n">coords</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i_grid</span><span class="p">):,</span> <span class="p">:],</span>
                                                      <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i_grid</span><span class="p">):,</span> <span class="p">:],</span>
                                                      <span class="n">i_iter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">i_subiter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span>
                                                      <span class="n">fn_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">],</span>
                                                      <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                      <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                    <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total parallel function evaluation </span><span class="si">{}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)),</span>
                                        <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                    <span class="c1"># append to results array containing all qoi</span>
                                    <span class="n">res_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">res_all</span><span class="p">,</span> <span class="n">res_new</span><span class="p">])</span>

                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]:</span>
                                        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                                        <span class="n">grad_res_3D_all</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                                     <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                                                     <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                                                                                     <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                                                                     <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                                                     <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">],</span>
                                                                                     <span class="n">gradient_results_present</span><span class="o">=</span><span class="n">grad_res_3D_all_FD_fwd</span><span class="p">,</span>
                                                                                     <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="n">gradient_idx_FD_fwd</span><span class="p">,</span>
                                                                                     <span class="n">i_iter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span>
                                                                                     <span class="n">i_subiter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span>
                                                                                     <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                                                     <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">],</span>
                                                                                     <span class="n">distance_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;distance_weight&quot;</span><span class="p">],</span>
                                                                                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FD_fwd&quot;</span><span class="p">:</span>
                                            <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="n">gradient_idx</span>
                                            <span class="n">grad_res_3D_all_FD_fwd</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span>

                                        <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                                               <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                    <span class="c1"># crop results to considered qoi</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                                        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">res_all</span><span class="p">)</span>
                                        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>

                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">res</span> <span class="o">=</span> <span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

                                        <span class="k">if</span> <span class="n">grad_res_3D_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                            <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

                                    <span class="n">i_grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                                    <span class="c1"># update classifier</span>
                                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Updating classifier ...&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">update_classifier</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                                                   <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

                                    <span class="c1"># TODO: the number of sub-gpcs could change here :/</span>
                                    <span class="c1"># update projection matrices</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]:</span>

                                        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">):</span>

                                            <span class="n">p_matrix</span><span class="p">[</span><span class="n">dd</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">determine_projection_matrix</span><span class="p">(</span>
                                                <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">[</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">gradient_idx</span><span class="p">]</span> <span class="o">==</span>
                                                                                 <span class="n">dd</span><span class="p">,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:],</span>
                                                <span class="n">lambda_eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;lambda_eps_gradient&quot;</span><span class="p">])</span>

                                            <span class="n">p_matrix_norm</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">[</span><span class="n">dd</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                            <span class="n">dim</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_matrix</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">]):</span>
                                                <span class="n">parameters</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s2">&quot;n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Beta</span><span class="p">(</span><span class="n">pdf_shape</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
                                                                                      <span class="n">pdf_limits</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

                                            <span class="n">problem</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                                            <span class="c1"># replace sub-gpc with the one containing the reduced problem</span>
                                            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">add_sub_gpc</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">[</span><span class="n">d</span><span class="p">],</span>
                                                                     <span class="n">order</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span>
                                                                               <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span>
                                                                     <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                                                                     <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                                                     <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span>
                                                                         <span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                                     <span class="n">interaction_order_current</span><span class="o">=</span>
                                                                     <span class="n">basis_order</span><span class="p">[</span><span class="s2">&quot;poly_dom_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">],</span>
                                                                     <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                                                     <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                                     <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                                            <span class="c1"># save original problem in gpc object</span>
                                            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">problem_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">problem_original</span><span class="p">)</span>

                                            <span class="c1"># save projection matrix in gPC object</span>
                                            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
                                            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix_norm</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                                            <span class="c1"># initialize domain specific interaction order and other settings</span>
                                            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>
                                            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span>

                                    <span class="c1"># update and assign grids</span>
                                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

                                    <span class="c1"># assign grids to sub-gPCs (rotate sub-grids in case of projection)</span>
                                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">assign_grids</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>

                                    <span class="c1"># update gpc matrix</span>
                                    <span class="n">gradient_idx_gpc</span> <span class="o">=</span> <span class="n">get_gradient_idx_domain</span><span class="p">(</span><span class="n">domains</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">,</span>
                                                                               <span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                                               <span class="n">gradient_idx</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gradient_idx</span><span class="p">)</span>

                                    <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx_gpc</span><span class="p">)</span>

                                    <span class="c1"># determine gpc coefficients</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                                        <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="n">grad_res_3D</span><span class="p">[</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">gradient_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="kc">None</span>

                                    <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
                                        <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span> <span class="o">==</span> <span class="n">d</span><span class="p">,</span> <span class="p">],</span>
                                        <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">,</span>
                                        <span class="n">solver</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
                                        <span class="n">settings</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                <span class="c1"># validate gpc approximation</span>
                                <span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                                                               <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                               <span class="n">domain</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                                                               <span class="n">output_idx</span><span class="o">=</span><span class="n">output_idx_passed_validation</span><span class="p">)</span>
                                <span class="n">error</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>

                                <span class="k">if</span> <span class="n">extended_basis</span> <span class="ow">or</span> <span class="n">first_iter</span><span class="p">:</span>
                                    <span class="n">eps_ref</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">delta_eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">error</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                                                        <span class="n">error</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">eps_ref</span><span class="p">)</span>

                                <span class="n">first_iter</span> <span class="o">=</span> <span class="kc">False</span>

                                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; Domain: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                       <span class="s2">&quot;error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                                           <span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                <span class="c1"># stop adaptive sampling and extend basis further if error</span>
                                <span class="c1"># was decreased (except in very first iteration)</span>
                                <span class="k">if</span> <span class="n">extended_basis</span> <span class="ow">and</span> <span class="n">error</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">error</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                                    <span class="k">break</span>

                                <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">False</span>

                                <span class="c1"># exit adaptive sampling loop if no adaptive sampling was chosen</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                                    <span class="k">break</span>

                    <span class="c1"># save gpc object and coeffs for this sub-iteration</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                            <span class="c1"># overwrite coeffs</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">d</span><span class="p">],</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                            <span class="c1"># overwrite domains</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;domains&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;domains&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                            <span class="c1"># save gpc matrix</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                             <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;p_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;p_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
                                                 <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span><span class="p">,</span>
                                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                            <span class="c1"># save gradient gpc matrix</span>
                            <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
                                                     <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span>
                                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                            <span class="c1"># save results</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;model_evaluations/results&quot;</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/results&quot;</span><span class="p">,</span>
                                             <span class="p">(</span><span class="n">res_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                             <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                             <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">res_all</span><span class="p">)</span>

                            <span class="c1"># save gradient of results</span>
                            <span class="k">if</span> <span class="n">grad_res_3D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">]</span>
                                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>

                                <span class="n">grad_res_2D_all</span> <span class="o">=</span> <span class="n">ten2mat</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">,</span>
                                                 <span class="p">(</span><span class="n">grad_res_2D_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grad_res_2D_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                 <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                                 <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
                                                 <span class="n">data</span><span class="o">=</span><span class="n">grad_res_2D_all</span><span class="p">)</span>

                                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">,</span>
                                                 <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">,</span>
                                                 <span class="n">data</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;error&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;error&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">eps</span><span class="p">[</span><span class="n">d</span><span class="p">],</span>
                                             <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                <span class="n">basis_increment</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">update_classifier</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                           <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">assign_grids</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>
            <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrices</span><span class="p">()</span>

            <span class="c1"># determine gpc coefficients</span>
            <span class="c1">#</span>
            <span class="c1">#     grad_res_3D_passed = grad_res_3D_all[:, q_idx, :][:, np.newaxis, :]</span>
            <span class="c1"># else:</span>
            <span class="c1">#     grad_res_3D_passed = None</span>

            <span class="c1"># crop results to considered qoi</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">res_all</span><span class="p">)</span>
                <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">grad_res_3D_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># determine gpc coefficients</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                               <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">,</span>
                                               <span class="n">solver</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
                                               <span class="n">settings</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                                               <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="c1"># save gpc object and gpc coeffs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_session</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">]</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session_folder&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;model_evaluations&quot;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">grad_res_3D_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ten2mat</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">),</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                                             <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                             <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                             <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="c1"># save gpc matrix</span>
                    <span class="k">for</span> <span class="n">i_gpc</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">domains</span><span class="p">)):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="c1"># save gradient gpc matrix</span>
                        <span class="k">if</span> <span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
                                                 <span class="n">data</span><span class="o">=</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span>
                                                 <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i_gpc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">):</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">)]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="k">for</span> <span class="n">i_gpc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">megpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_gpc</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span> <span class="o">+</span> <span class="s2">&quot;/dom_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_gpc</span><span class="p">),</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">][</span><span class="n">i_gpc</span><span class="p">],</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

        <span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">megpc</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">res_all</span></div></div>


<div class="viewcode-block" id="RegAdaptiveProjection"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.RegAdaptiveProjection">[docs]</a><span class="k">class</span> <span class="nc">RegAdaptiveProjection</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adaptive regression approach using projection and leave one out cross validation error estimation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    problem: Problem class instance</span>
<span class="sd">        GPC problem under investigation</span>
<span class="sd">    options[&quot;order_start&quot;] : int, optional, default=0</span>
<span class="sd">          Initial gPC expansion order (maximum order)</span>
<span class="sd">    options[&quot;order_end&quot;] : int, optional, default=10</span>
<span class="sd">        Maximum Gpc expansion order to expand to (algorithm will terminate afterwards)</span>
<span class="sd">    options[&quot;interaction_order&quot;]: int, optional, default=dim</span>
<span class="sd">        Define maximum interaction order of parameters (default: all interactions)</span>
<span class="sd">    options[&quot;order_max_norm&quot;]: float</span>
<span class="sd">        Norm for which the maximum global expansion order is defined [0, 1]. Values &lt; 1 decrease the total number</span>
<span class="sd">        of polynomials in the expansion such that interaction terms are penalized more. This truncation scheme</span>
<span class="sd">        is also referred to &quot;hyperbolic polynomial chaos expansion&quot; such that sum(a_i^q)^1/q &lt;= p,</span>
<span class="sd">        where p is order_max and q is order_max_norm (for more details see eq. (27) in [1]).</span>
<span class="sd">    options[&quot;n_grid_gradient&quot;] : float, optional, default: 10</span>
<span class="sd">        Number of initial grid points to determine gradient and projection matrix. When the algorithm goes</span>
<span class="sd">        into the main interations the number will be increased depending on the options &quot;matrix_ratio&quot;</span>
<span class="sd">        and &quot;adaptive_sampling&quot;.</span>
<span class="sd">    options[&quot;qoi&quot;] : int or str, optional, default: 0</span>
<span class="sd">        Choose for which QOI the projection is determined for. The other QOIs use the same projection.</span>
<span class="sd">        Alternatively, the projection can be determined for every QOI independently (qoi_index or &quot;all&quot;).</span>
<span class="sd">    options[&quot;adaptive_sampling&quot;] : boolean, optional, default: True</span>
<span class="sd">        Adds samples adaptively to the expansion until the error is converged and continues by</span>
<span class="sd">        adding new basis functions.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pygpc</span>
<span class="sd">    &gt;&gt;&gt; # initialize adaptive gPC algorithm</span>
<span class="sd">    &gt;&gt;&gt; algorithm = pygpc.RegAdaptiveProjection(problem=problem, options=options)</span>
<span class="sd">    &gt;&gt;&gt; # run algorithm</span>
<span class="sd">    &gt;&gt;&gt; gpc, coeffs, results = algorithm.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor; Initializes RegAdaptiveProjection algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegAdaptiveProjection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>

        <span class="c1"># check contents of settings dict and set defaults</span>
        <span class="k">if</span> <span class="s2">&quot;order_start&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;order_end&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="s2">&quot;interaction_order&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dim</span>

        <span class="k">if</span> <span class="s2">&quot;order_max_norm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="s2">&quot;n_grid_gradient&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid_gradient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="s2">&quot;qoi&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;adaptive_sampling&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qoi_specific</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="RegAdaptiveProjection.run"><a class="viewcode-back" href="../../pygpc.html#pygpc.Algorithm.RegAdaptiveProjection.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs adaptive gPC algorithm using projection to solve problem.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gpc : GPC object instance</span>
<span class="sd">            GPC object containing all information i.e., Problem, Model, Grid, Basis, RandomParameter instances</span>
<span class="sd">        coeffs: ndarray of float [n_basis x n_out]</span>
<span class="sd">            GPC coefficients</span>
<span class="sd">        res : ndarray of float [n_grid x n_out]</span>
<span class="sd">            Simulation results at n_grid points of the n_out output variables</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;_temp.hdf5&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;_temp.hdf5&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gradient_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># initialize iterators</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span>
        <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nrmsd</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">loocv</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># make initial grid to determine gradients and projection matrix. By default, it is an LHS (ese) grid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using user-predefined grid with n_grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                                 <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                                 <span class="n">coords_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                                 <span class="n">coords_gradient</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                                 <span class="n">coords_gradient_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Random</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GP</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating initial grid (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) with n_grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;n_grid_gradient&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                                 <span class="n">n_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid_gradient&quot;</span><span class="p">],</span>
                                                 <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating initial grid (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) with n_grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;n_grid_gradient&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">grid_original</span> <span class="o">=</span> <span class="n">LHS</span><span class="p">(</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                <span class="n">n_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_grid_gradient&quot;</span><span class="p">],</span>
                                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;criterion&quot;</span><span class="p">:</span> <span class="s2">&quot;ese&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">][</span><span class="s2">&quot;seed&quot;</span><span class="p">]})</span>

        <span class="c1"># Initialize parallel Computation class</span>
        <span class="n">com</span> <span class="o">=</span> <span class="n">Computation</span><span class="p">(</span><span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cpu</span><span class="p">,</span> <span class="n">matlab_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matlab_model&quot;</span><span class="p">])</span>

        <span class="c1"># Run initial simulations to determine initial projection matrix</span>
        <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">{}</span><span class="s2"> simulations!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
               <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">res_all</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                          <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                          <span class="n">coords</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                          <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                          <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                          <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                          <span class="n">fn_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">],</span>
                          <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="n">i_grid</span> <span class="o">=</span> <span class="n">grid_original</span><span class="o">.</span><span class="n">n_grid</span>

        <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
               <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="c1"># Determine gradient for projection matrix (method: FD_fwd)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">grad_res_3D_all</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                     <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                     <span class="n">grid</span><span class="o">=</span><span class="n">grid_original</span><span class="p">,</span>
                                                     <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                                     <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                     <span class="n">method</span><span class="o">=</span><span class="s2">&quot;FD_fwd&quot;</span><span class="p">,</span>
                                                     <span class="n">gradient_results_present</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                     <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                     <span class="n">i_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                                                     <span class="n">i_subiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                     <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                     <span class="n">dx</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
                                                     <span class="n">distance_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="n">gradient_idx</span>
        <span class="n">grad_res_3D_all_FD_fwd</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span>

        <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
               <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

        <span class="c1"># set qoi indices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">res_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">n_qoi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">qoi_idx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]]</span>
            <span class="n">n_qoi</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># init variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qoi</span><span class="p">)]</span>
        <span class="n">gpc</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qoi</span><span class="p">)]</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_qoi</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># loop over qoi (projection is qoi specific)</span>
        <span class="k">for</span> <span class="n">i_qoi</span><span class="p">,</span> <span class="n">q_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qoi_idx</span><span class="p">):</span>

            <span class="n">basis_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                                    <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">])])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">qoi_idx_validate</span> <span class="o">=</span> <span class="n">q_idx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qoi_idx_validate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">res_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">first_iter</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># crop results to considered qoi</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">res_all</span><span class="p">)</span>
                <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>
                <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">hdf5_subfolder</span> <span class="o">=</span> <span class="s2">&quot;/qoi_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q_idx</span><span class="p">)</span>

            <span class="c1"># copy results of initial simulation</span>
            <span class="c1"># shutil.copy2(os.path.splitext(self.options[&quot;fn_results&quot;])[0] + &quot;_temp.hdf5&quot;, fn_results + &quot;.hdf5&quot;)</span>

            <span class="c1"># Set up initial reduced problem</span>
            <span class="c1"># Determine projection matrix</span>
            <span class="n">p_matrix</span><span class="p">,</span> <span class="n">p_matrix_complete</span> <span class="o">=</span> <span class="n">determine_projection_matrix</span><span class="p">(</span><span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:],</span>
                                                                      <span class="n">lambda_eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;lambda_eps_gradient&quot;</span><span class="p">])</span>
            <span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Set up initial reduced problem</span>
            <span class="n">dim_reduced</span> <span class="o">=</span> <span class="n">p_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parameters_reduced</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_reduced</span><span class="p">):</span>
                <span class="n">parameters_reduced</span><span class="p">[</span><span class="s2">&quot;n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Beta</span><span class="p">(</span><span class="n">pdf_shape</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">pdf_limits</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters_reduced</span><span class="p">)</span>

            <span class="c1"># Create initial reduced gPC object</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">Reg</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                             <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_reduced</span><span class="p">)],</span>
                             <span class="n">order_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">],</span>
                             <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                             <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                             <span class="n">interaction_order_current</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                             <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                             <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

            <span class="c1"># save original problem in gpc object</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span>

            <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># save projection matrix in gPC object</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">)</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix_norm</span><span class="p">)</span>

            <span class="c1"># copy global grid, passing it from qoi to qoi but in the first iteration, we have to initialize a new</span>
            <span class="c1"># grid in case of L1, L1_LHS, LHS_L1 and FIM because they depend on the gpc object which can be different</span>
            <span class="c1"># for every QOI due to different projections and termination criteria. We are passing the coordinates</span>
            <span class="c1"># of the initial LHS (ese) grid to it</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">L1</span><span class="p">,</span> <span class="n">L1_LHS</span><span class="p">,</span> <span class="n">LHS_L1</span><span class="p">,</span> <span class="n">FIM</span><span class="p">]:</span>
                <span class="n">grid_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">](</span><span class="n">parameters_random</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">parameters_random</span><span class="p">,</span>
                                                     <span class="n">coords</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                                     <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                                     <span class="n">coords_gradient</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                                     <span class="n">coords_gradient_norm</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                                     <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid_options&quot;</span><span class="p">],</span>
                                                     <span class="n">gpc</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">])</span>

            <span class="c1"># assign transformed grid</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">project_grid</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid_original</span><span class="p">,</span> <span class="n">p_matrix</span><span class="o">=</span><span class="n">p_matrix</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;reduce&quot;</span><span class="p">)</span>

            <span class="c1"># Initialize gpc matrix</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_grid</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">n_basis</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span>

            <span class="c1"># Main iterations (order)</span>
            <span class="k">while</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>

                <span class="k">if</span> <span class="n">first_iter</span><span class="p">:</span>
                    <span class="n">basis_increment</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">basis_increment</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># increase basis</span>
                <span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">increment_basis</span><span class="p">(</span><span class="n">order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                 <span class="n">interaction_order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                 <span class="n">interaction_order_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">]),</span>
                                                                 <span class="n">incr</span><span class="o">=</span><span class="n">basis_increment</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_end&quot;</span><span class="p">]:</span>
                    <span class="k">break</span>

                <span class="c1"># update basis</span>
                <span class="n">b_added</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">set_basis_poly</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
                                                                <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
                                                          <span class="n">order_max</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                          <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                                          <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                          <span class="n">interaction_order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                          <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">])</span>

                <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;Order/Interaction order: </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">iprint</span><span class="p">(</span><span class="n">print_str</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>
                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_str</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">b_added</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Starting adaptive sampling:&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                <span class="n">add_samples</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># if adaptive sampling is False, the while loop will be only executed once</span>
                <span class="n">delta_eps_target</span> <span class="o">=</span> <span class="mf">1e-1</span>
                <span class="n">delta_eps</span> <span class="o">=</span> <span class="n">delta_eps_target</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">delta_samples</span> <span class="o">=</span> <span class="mf">5e-2</span>

                <span class="k">if</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="n">eps_ref</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">while</span> <span class="n">add_samples</span> <span class="ow">and</span> <span class="n">delta_eps</span> <span class="o">&gt;</span> <span class="n">delta_eps_target</span> <span class="ow">and</span> <span class="n">eps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                        <span class="n">add_samples</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># new sample size</span>
                    <span class="k">if</span> <span class="n">extended_basis</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                        <span class="c1"># don&#39;t increase sample size immediately when basis was extended, try first with old samples</span>
                        <span class="n">n_grid_new</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                        <span class="c1"># increase sample size stepwise (adaptive sampling)</span>
                        <span class="n">n_grid_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span> <span class="o">+</span> <span class="n">delta_samples</span> <span class="o">*</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">n_basis</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># increase sample size according to matrix ratio w.r.t. number of basis functions</span>
                        <span class="n">n_grid_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">n_basis</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;matrix_ratio&quot;</span><span class="p">]))</span>

                    <span class="c1"># run model and update projection matrix if grid points were added</span>
                    <span class="c1"># (Skip simulations of first run because we already simulated it)</span>
                    <span class="k">if</span> <span class="n">i_grid</span> <span class="o">&lt;</span> <span class="n">n_grid_new</span> <span class="ow">or</span> <span class="n">extended_basis</span><span class="p">:</span>
                        <span class="c1"># extend grid</span>
                        <span class="k">if</span> <span class="n">i_grid</span> <span class="o">&lt;</span> <span class="n">n_grid_new</span><span class="p">:</span>
                            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Extending grid from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> by </span><span class="si">{}</span><span class="s2"> sampling points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">,</span> <span class="n">n_grid_new</span><span class="p">,</span> <span class="n">n_grid_new</span> <span class="o">-</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">n_grid</span><span class="p">),</span>
                                <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                            <span class="n">grid_original</span><span class="o">.</span><span class="n">gpc</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span>
                            <span class="n">grid_original</span><span class="o">.</span><span class="n">extend_random_grid</span><span class="p">(</span><span class="n">n_grid_new</span><span class="o">=</span><span class="n">n_grid_new</span><span class="p">)</span>

                            <span class="c1"># run simulations</span>
                            <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Performing simulations &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_grid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span>
                                   <span class="nb">str</span><span class="p">(</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                   <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                            <span class="n">res_new</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                              <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                              <span class="n">coords</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i_grid</span><span class="p">:</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                              <span class="n">coords_norm</span><span class="o">=</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">[</span>
                                                          <span class="n">i_grid</span><span class="p">:</span><span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                              <span class="n">i_iter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">i_subiter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                              <span class="n">fn_results</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">fn_results</span><span class="p">,</span>
                                              <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                              <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                            <span class="n">res_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">res_all</span><span class="p">,</span> <span class="n">res_new</span><span class="p">))</span>

                            <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Total parallel function evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                                   <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                            <span class="n">i_grid</span> <span class="o">=</span> <span class="n">grid_original</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                            <span class="c1"># Determine gradient and update projection matrix in case of gradient enhanced gPC</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]:</span>
                                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                                <span class="n">grad_res_3D_all</span><span class="p">,</span> <span class="n">gradient_idx</span> <span class="o">=</span> <span class="n">get_gradient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                             <span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="p">,</span>
                                                                             <span class="n">grid</span><span class="o">=</span><span class="n">grid_original</span><span class="p">,</span>
                                                                             <span class="n">results</span><span class="o">=</span><span class="n">res_all</span><span class="p">,</span>
                                                                             <span class="n">com</span><span class="o">=</span><span class="n">com</span><span class="p">,</span>
                                                                             <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">],</span>
                                                                             <span class="n">gradient_results_present</span><span class="o">=</span><span class="n">grad_res_3D_all_FD_fwd</span><span class="p">,</span>
                                                                             <span class="n">gradient_idx_skip</span><span class="o">=</span><span class="n">gradient_idx_FD_fwd</span><span class="p">,</span>
                                                                             <span class="n">i_iter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                             <span class="n">i_subiter</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                             <span class="n">print_func_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;print_func_time&quot;</span><span class="p">],</span>
                                                                             <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;dx&quot;</span><span class="p">],</span>
                                                                             <span class="n">distance_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation_options&quot;</span><span class="p">][</span><span class="s2">&quot;distance_weight&quot;</span><span class="p">],</span>
                                                                             <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_calculation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FD_fwd&quot;</span><span class="p">:</span>
                                    <span class="n">gradient_idx_FD_fwd</span> <span class="o">=</span> <span class="n">gradient_idx</span>
                                    <span class="n">grad_res_3D_all_FD_fwd</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span>

                                <span class="n">iprint</span><span class="p">(</span><span class="s1">&#39;Gradient evaluation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sec&#39;</span><span class="p">,</span>
                                       <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                <span class="c1"># Determine projection matrix</span>
                                <span class="n">p_matrix</span><span class="p">,</span> <span class="n">p_matrix_complete</span> <span class="o">=</span> <span class="n">determine_projection_matrix</span><span class="p">(</span><span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:],</span>
                                                                                          <span class="n">lambda_eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;lambda_eps_gradient&quot;</span><span class="p">])</span>
                                <span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                                <span class="c1"># save projection matrix in gPC object</span>
                                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">)</span>
                                <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix_norm</span><span class="p">)</span>

                                <span class="c1"># Set up reduced gPC</span>
                                <span class="n">dim_reduced</span> <span class="o">=</span> <span class="n">p_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;Dimension of reduced problem: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dim_reduced</span><span class="p">),</span>
                                       <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                                <span class="c1"># Update gPC object if dimension has changed</span>
                                <span class="k">if</span> <span class="n">dim_reduced</span> <span class="o">!=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span>
                                    <span class="n">parameters_reduced</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_reduced</span><span class="p">):</span>
                                        <span class="n">parameters_reduced</span><span class="p">[</span><span class="s2">&quot;n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Beta</span><span class="p">(</span><span class="n">pdf_shape</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
                                                                                   <span class="n">pdf_limits</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

                                    <span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                          <span class="n">parameters</span><span class="o">=</span><span class="n">parameters_reduced</span><span class="p">)</span>

                                    <span class="c1"># Create reduced gPC object of order - 1 and add rest of basisfunctions</span>
                                    <span class="c1"># of this subiteration afterwards</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">Reg</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                                                     <span class="n">order</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_reduced</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
                                                     <span class="n">order_max</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="n">order_max_norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_max_norm&quot;</span><span class="p">],</span>
                                                     <span class="n">interaction_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;interaction_order&quot;</span><span class="p">],</span>
                                                     <span class="n">interaction_order_current</span><span class="o">=</span><span class="n">basis_order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                     <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                                                     <span class="n">validation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

                                    <span class="c1"># save original problem</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">problem_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span>

                                    <span class="c1"># save projection matrix in gPC object</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix</span><span class="p">)</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">p_matrix_norm</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p_matrix_norm</span><span class="p">)</span>

                                    <span class="c1"># Save settings and options in gpc object</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;settings&quot;</span><span class="p">]</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">relative_error_nrmsd</span> <span class="o">=</span> <span class="n">nrmsd</span>
                                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">relative_error_loocv</span> <span class="o">=</span> <span class="n">loocv</span>

                    <span class="c1"># assign transformed grid</span>
                    <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">project_grid</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid_original</span><span class="p">,</span> <span class="n">p_matrix</span><span class="o">=</span><span class="n">p_matrix</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;reduce&quot;</span><span class="p">)</span>

                    <span class="c1"># in case of L1, L1-LHS, LHS-L1 or FIM grids copy new gpc object into it</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">L1</span><span class="p">,</span> <span class="n">L1_LHS</span><span class="p">,</span> <span class="n">LHS_L1</span><span class="p">,</span> <span class="n">FIM</span><span class="p">]:</span>
                        <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">gpc</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span>

                    <span class="c1"># crop results to considered qoi</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;qoi&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">res_all</span><span class="p">)</span>
                        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">res_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                        <span class="n">grad_res_3D</span> <span class="o">=</span> <span class="n">grad_res_3D_all</span><span class="p">[:,</span> <span class="n">q_idx</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

                    <span class="c1"># Someone might not use the gradient to determine the gpc coeffs</span>
                    <span class="k">if</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gradient</span><span class="p">:</span>
                        <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="n">grad_res_3D</span>
                        <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">grad_res_3D_passed</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">init_gpc_matrix</span><span class="p">(</span><span class="n">gradient_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                    <span class="c1"># determine gpc coefficients</span>
                    <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                                     <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">,</span>
                                                     <span class="n">solver</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
                                                     <span class="n">settings</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                                                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="c1"># Add a validation set if nrmsd is chosen and no validation set is yet present</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="p">,</span> <span class="n">ValidationSet</span><span class="p">):</span>
                        <span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">create_validation_set</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_samples_validation&quot;</span><span class="p">],</span>
                                                     <span class="n">n_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;n_cpu&quot;</span><span class="p">])</span>

                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nrmsd&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="p">,</span> <span class="n">ValidationSet</span><span class="p">):</span>
                        <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="p">)</span>

                    <span class="c1"># validate gpc approximation (determine nrmsd or loocv specified in options[&quot;error_type&quot;])</span>
                    <span class="n">eps</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span>
                                              <span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                              <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">,</span>
                                              <span class="n">qoi_idx</span><span class="o">=</span><span class="n">qoi_idx_validate</span><span class="p">)</span>

                    <span class="c1"># save error in case that dimension has changed and the gpc object had to be reinitialized</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
                    <span class="n">nrmsd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">relative_error_nrmsd</span><span class="p">)</span>
                    <span class="n">loocv</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">relative_error_loocv</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">extended_basis</span> <span class="ow">or</span> <span class="n">first_iter</span><span class="p">:</span>
                        <span class="n">eps_ref</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">delta_eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">eps_ref</span><span class="p">)</span>

                    <span class="n">first_iter</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">iprint</span><span class="p">(</span><span class="s2">&quot;-&gt; </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> error = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_norm&quot;</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">],</span>
                                                        <span class="n">eps</span><span class="p">),</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

                    <span class="c1"># extend basis further if error was decreased (except in very first iteration)</span>
                    <span class="k">if</span> <span class="n">order</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">extended_basis</span> <span class="ow">and</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="k">break</span>

                    <span class="n">extended_basis</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># exit adaptive sampling loop if no adaptive sampling was chosen</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;adaptive_sampling&quot;</span><span class="p">]:</span>
                        <span class="k">break</span>

                <span class="c1"># save gpc object and coeffs for this sub-iteration</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fn_results</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c1"># overwrite coeffs</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="c1"># save projection matrix</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;p_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;p_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">p_matrix</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="c1"># save gradient of results</span>
                        <span class="k">if</span> <span class="n">grad_res_3D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">]</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="n">grad_res_2D_all</span> <span class="o">=</span> <span class="n">ten2mat</span><span class="p">(</span><span class="n">grad_res_3D_all</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results&quot;</span><span class="p">,</span>
                                             <span class="p">(</span><span class="n">grad_res_2D_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grad_res_2D_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                             <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                             <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">,</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">grad_res_2D_all</span><span class="p">)</span>

                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;model_evaluations/gradient_results_idx&quot;</span><span class="p">,</span>
                                             <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">,</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">gradient_idx</span><span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;gpc_matrix_gradient&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                             <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">gpc_matrix_gradient</span><span class="p">,</span>
                                             <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;error&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;error&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

            <span class="c1"># determine gpc coefficients</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                             <span class="n">gradient_results</span><span class="o">=</span><span class="n">grad_res_3D_passed</span><span class="p">,</span>
                                             <span class="n">solver</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
                                             <span class="n">settings</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                                             <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">])</span>

            <span class="c1"># save original grid</span>
            <span class="n">gpc</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">]</span><span class="o">.</span><span class="n">grid_original</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grid_original</span><span class="p">)</span>

            <span class="c1"># save gpc object gpc coeffs and projection matrix</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fn_session</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">][:]</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session&quot;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/fn_session_folder&quot;</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_session_folder&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;|S&quot;</span><span class="p">))</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;coeffs&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">coeffs</span><span class="p">[</span><span class="n">i_qoi</span><span class="p">],</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;p_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;p_matrix&quot;</span> <span class="o">+</span> <span class="n">hdf5_subfolder</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">p_matrix</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;gradient_enhanced&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">gpc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;grid/coords_gradient_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_gradient_norm</span><span class="p">,</span>
                                         <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

            <span class="c1"># reset iterators</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_start&quot;</span><span class="p">]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nrmsd</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">loocv</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;fn_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn_results</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/model_evaluations/results&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;validation/grid/coords_norm&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gpc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">coords_norm</span><span class="p">,</span>
                                     <span class="n">maxshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">]</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;misc/error_type&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">])</span>

        <span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">gpc</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">res</span></div></div>
</pre></div>
<div class="section">
   
</div>

            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2022, Konstantin Weise.<br>

</p>

  </div>
  
  <div class="footer-item">
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">
        PyData Sphinx Theme
    </a>
    0.12.0.
</p>
  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>